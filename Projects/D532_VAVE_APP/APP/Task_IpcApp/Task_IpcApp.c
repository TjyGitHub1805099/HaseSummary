/*!Warning!:Please don't modify this file,this is generated by tools!*/
/********************************************************************
File name: Task_IpcApp.c
Author: Stephen Du
Version: V1.0
Timestamp: 2017-05-26 17:32:05
Description:
Others:
Function List:
1. ....
History: /
1. Date:
Author:
Modification:
2. ...
********************************************************************/
#define IOC_PLATFORM
//#include "System_Task_If.h"
//#include "System_Signal_If.h"
#include "Task_IpcApp_Cfg.h"
#if (STD_ON == TASK_IPCAPP_DEBUG_TRACE)
#include "trace.h"
#endif
#include "osif.h" 
#include "portmacro.h"
#include "task.h"
#include "stdio.h"
#include "dea.h"
#include "string.h"
#include "Gear.h"
#include "Vel.h"
#include "FuelProc.h"
#include "odo.h"
#include "avs.h"
#include "afc.h"
#include "MaintainServiceCfg.h"
#include "MaintainService.h"
#include "DeaCoding.h"
#include "VEL_LT_cfg.h"
#include "system_S32K148.h"
#include "BoardDefines.h"
#include "Spi_Ipc_gw_api.h"
#include "System_Signal.h"
#include "pmStateMachine_If.h"
#include "audio_control_api.h"
#include"CanApp.h"
#include "dte.h"
#include "pin_wrapper_if.h"
#include "semi_active_check.h"
#include "sys_setting.h"
#include "IdleStopTime.h"
#include "System_Task_Cfg.h"
#include "System_Task.h"
#include "PowerSupply.h"
#include "Vel_cfg.h"
#include "HistoryAfc.h"
#include "HardwareVersion.h"



//#define IPC_TEST
const uint8_t s_IpcAudioIdTable[][2]=
{
	{NORMAL_MSG_ID_DoorOpenBuzzer, BEEP_METER_Door_Open_Buzzer},
	{NORMAL_MSG_ID_BackdoorOpen, BEEP_METER_Door_Open_Buzzer},
	{NORMAL_MSG_ID_LightLeftOnAlarm, BEEP_METER_LIGHT_LEFTON},
	{NORMAL_MSG_ID_SmartKeyInReminderBuzzer, BEEP_METER_KEY_LEFT},
	{NORMAL_MSG_ID_KeyInIgnitionReminder, BEEP_METER_KEY_LEFT},
	{NORMAL_MSG_ID_SmartKey_OFF_PositionReminderBuzzer, BEEP_METER_OFF_POSITION},
	{NORMAL_MSG_ID_E_PKBWarningBuzzer, BEEP_METER_E_PKB},
	{NORMAL_MSG_ID_SmartRemoteOutOfCarReminderBuzzer, BEEP_METER_NOT_P},
	{NORMAL_MSG_ID_IdleStopBuzzer, BEEP_METER_IDLE_STOP},
	{NORMAL_MSG_ID_SeatBeltWarning, BEEP_METER_SEAT_BEALT_WARNING},
	{NORMAL_MSG_ID_TireAlarm,  BEEP_METER_TIRE_AIR_PRESSURE_ALARM},
	{NORMAL_MSG_ID_UserModeSwitch, BEEP_METER_USER_MODE},
	{NORMAL_MSG_ID_ParkingBrakLeftReminder, BEEP_METER_PKB_ALARM},
	{NORMAL_MSG_ID_IlluminationControlMaxMin, BEEP_METER_MULTIDISPLAY},
	{NORMAL_MSG_ID_MultidisplayAlarmSound, BEEP_METER_MULTIDISPLAY},
	{NORMAL_MSG_ID_AT_GearRefuseBuzzer, BEEP_METER_AT_GEAR},
	{NORMAL_MSG_ID_SonarLV1_Buzzer, BEEP_SONAR_LV1},
	{NORMAL_MSG_ID_SonarLV2_Buzzer, BEEP_SONAR_LV2},
	{NORMAL_MSG_ID_SonarLV3_Buzzer, BEEP_SONAR_LV3},
	{NORMAL_MSG_ID_SonarLV4_Buzzer, BEEP_SONAR_LV4},
	{NORMAL_MSG_ID_FCW_Buzzer, BEEP_FCW},
	{NORMAL_MSG_ID_FEB_Buzzer, BEEP_FEB},
	//{NORMAL_MSG_ID_BSW_Buzzer, BEEP_BSW},
	{NORMAL_MSG_ID_LDW_Buzzer, BEEP_LDW},
	{NORMAL_MSG_ID_EAPM_Buzzer, BEEP_METER_EAPM},
	{NORMAL_MSG_ID_MOD_Buzzer, BEEP_METER_MOD},
	{NORMAL_MSG_ID_PressBrakePedalD_Rank, BEEP_METER_E_PKB},
	{NORMAL_MSG_ID_SlopeIsTooLarge, BEEP_METER_E_PKB},
	{NORMAL_MSG_ID_PressTheBrakePedal, BEEP_METER_E_PKB},
	{NORMAL_MSG_ID_E_PKB_NotReleasedRepeat, BEEP_METER_E_PKB},
	{NORMAL_MSG_ID_E_PKB_NotReleased, BEEP_METER_E_PKB},
	/* yangxl */
	{NORMAL_MSG_ID_UPA_SelfCheck_Buzzer,BEEP_UPA_500MS},
	{NORMAL_MSG_ID_UPA_Fault_Buzzer,BEEP_UPA_3000MS},
	{NORMAL_MSG_ID_FAP_FindParking_Buzzer,BEEP_FAP_1},
	{NORMAL_MSG_ID_FAP_FindParkingSlowDown_Buzzer,BEEP_FAP_1},
	{NORMAL_MSG_ID_FAP_QuitFindParking_Buzzer,BEEP_FAP_2},
	{NORMAL_MSG_ID_FAP_APAStart_Buzzer,BEEP_FAP_1},
	{NORMAL_MSG_ID_FAP_APAComplete_Buzzer,BEEP_FAP_1},
	{NORMAL_MSG_ID_FAP_APASuspended_Buzzer,BEEP_FAP_2},
	{NORMAL_MSG_ID_FAP_APAQuit_Buzzer,BEEP_FAP_2},
	{NORMAL_MSG_ID_LKA_Standby_Buzzer,BEEP_LKA_STANDBY},
	{NORMAL_MSG_ID_LKA_Controlling_Buzzer,BEEP_LKA_CONTROLLING},
	{NORMAL_MSG_ID_LKA_ToSell_Buzzer,BEEP_LKA_HAND_LEAVE},
	{NORMAL_MSG_ID_LKA_DrvrTkovReq_Buzzer,BEEP_LKA_ASK_CONTROL},
	{NORMAL_MSG_ID_ACC_DrvrTkov_Buzzer,BEEP_ACC},

	{NORMAL_MSG_ID_TrFaultContBuzzer,BEEP_METER_NOT_P},
	/* yangxl */
};

static BASIC_FAST_STRU s_basicFast = {0};
static BASIC_MIDDLE_STRU s_basicMiddle = {0};
static BASIC_SLOW_STRU s_basicSlow = {0};
static IPC_APP_SYS_CTRL_STRU s_sysCtrl = {0};
static IPC_APP_BUTTON_STRU s_buttonMsg = {0};
static IPC_APP_SEMI_SET_STRU s_sysSemiSetMsg = {0};
static IPC_APP_SYS_SETTING_STRU s_sysSetMsg = {0};
static IPC_APP_TIME_INFO_STRU s_sysTimeInfoMsg = {0};
static IPC_APP_DRIVE_TIME_STRU s_DriveTime = {0};
static IPC_APP_IDLE_STOP_INFO_STRU s_IdleStopInfo = {0};
//static IPC_APP_HISTORY_AVG_FUEL_STRU s_HistoryAvgFuel = {0};
static uint32_t s_hardware_state = 0;
static uint8_t s_power_on_update_flag = 0;
static IPC_APP_DIAG_BUF_STRU s_DiagDataBuf = {0};
static IPC_APP_DIAG_L351_BUF_STRU s_DiagL351DataBuf = {0};

static IPC_SELF_DIAG_DYNAMIC_STRU s_SelfDiagDynamic = {0};
static IPC_SELF_DIAG_STATIC_STRU s_SelfDiagStatic = {0};



static IPC_APP_MSG_STRU s_WarnMsgBuf[10] __attribute__((section(".data")));
static MSG_RING_STRU s_warnMsgRing = {0};
static IPC_APP_MSG_STRU s_normalMsgBuf[20] __attribute__((section(".data")));
static MSG_RING_STRU s_normalMsgRing = {0};

volatile static uint8_t s_timeUpdateFlag = 0;

static IPC_APP_EVENT_BUF_STRU s_EventBuf[IPC_APP_EVENT_SIZE] __attribute__((section(".data"))) ;
volatile static uint8_t s_EventCnt = 0U;
volatile uint8_t s_SocReadyOkFlag = 0U;
//static uint8_t s_UpdateBestHisFuelFlag = 1;
static uint8_t s_ResetHisFuelFlag = 0;
static uint8_t s_ipc_debug_flag = 0;
static uint8_t CarBodySetInProgress = 0;
volatile uint8_t s_IpcConnectedStatus = 0U;
volatile uint8_t s_IpcResetSocFlag = 0;



static IPC_APP_EVENT_BUF_STRU s_EventBufChCan[IPC_APP_EVENT_CH_CAN_SIZE] __attribute__((section(".data")));
volatile static uint8_t s_EventCntChCan = 0U;
static IPC_IOC_STAT_STRU s_IocStat = {0};
static uint8_t s_IocStatUpdate_flag = 1;
static uint8_t s_IocDteStatUpdate_flag = 1;


static uint8_t s_CanMessageTimeoutStat[IPC_EVENT_DATA_BUF_SIZE] __attribute__((section(".data"))) = {0};

#if 1
#define ic_ipc_gw_init() 
#define ic_ipc_gw_register(channel, call) register_Spi_ipc_callback(0,channel,call)
#define Ic_ipc_gw_send_notification(channel,function,feature,data,len) Ic_Ipc_send_notification(0,channel,function,feature,data,len)
#define ipc_gw_is_ch_connected(a) (s_SocReadyOkFlag)
#define Std_SuspendAllInterrupts() portDISABLE_INTERRUPTS()
#define Std_ResumeAllInterrupts() portENABLE_INTERRUPTS()
#endif



#if (STD_OFF == TASK_IPCAPP_DEBUG_TRACE)
#ifndef IPC_TRACE
	#define IPC_TRACE 0
#endif
//#define TracePrintf(a,b,c,d,...) ;//(a,b,c,d)
#endif

uint32_t s_start,s_end;

uint8_t s_event_rm_cnt = 0, s_event_rm_cnt_f = 0;

static void RemoveReqEvent(uint16_t index);
static void RemoveReqEventChCan(uint16_t index);
static void Ntf_CbProc(uint16_t function, uint8_t *data, uint16_t len);
static void IPC_SetSocReadyOkFlag(uint8_t flag);


static void ntf_cb_ch_req(uint16_t function, uint16_t feature, uint8_t *rx_data, int32_t len)
{
	//uint32_t i;
	//char buf[30] = {0};
	//TracePrintf(IPC_TRACE,0,0,0,"ntf_cb_ch1 is called\n\r");
	s_end = xTaskGetTickCount();

	if(feature == IPC_FEATURE_SOC_REP)
	{
		RemoveReqEvent(function);
	}
	else if(feature == IPC_FEATURE_SOC_REQ)
	{
		Ntf_CbProc(function, rx_data, len);
#if (STD_ON == TASK_IPCAPP_DEBUG_TRACE)
		TracePrintf(IPC_TRACE,0,0,0, "[T-IPC]Soc Req\r\n");
#endif
	}
	
#if 0//(STD_ON == TASK_IPCAPP_DEBUG_TRACE)	
	if(len > 0)
	{
		sprintf(buf, "[T-IPC]ntf_ch1: T:%d ", s_end-s_start);
		for(i = 0; i < len; i++)
			sprintf(buf+strlen(buf), "%02x ", rx_data[i]);
	
		sprintf(buf+strlen(buf), "!\r\n");


		TracePrintf(IPC_TRACE,0,0,0, "%s", buf);
	}
	else
	{
		TracePrintf(IPC_TRACE,0,0,0, "inv_ch1: T:%d \r\n", s_end-s_start);
	}
#endif
}

static void ntf_cb_ch_ntf(uint16_t function, uint16_t feature, uint8_t *rx_data, int32_t len)
{

}



static void ntf_cb_ch_can(uint16_t function, uint16_t feature, uint8_t *rx_data, int32_t len)
{
	if(feature == IPC_FEATURE_SOC_REP)
	{
#if (STD_ON == TASK_IPCAPP_DEBUG_TRACE)
		TracePrintf(IPC_TRACE,0,0,0, "[T-IPC]S:%d\r\n", function);
#endif
		RemoveReqEventChCan(function);
	}
	else if(feature == IPC_FEATURE_SOC_REQ)
	{
		Ntf_CbProc(function, rx_data, len);
#if (STD_ON == TASK_IPCAPP_DEBUG_TRACE)
		TracePrintf(IPC_TRACE,0,0,0, "[T-IPC]Soc Req\r\n");
#endif
	}
	else if(feature == IPC_FRATURE_SOC_NTF)
	{
		Ntf_CbProc(function, rx_data, len);
	}
}

static void ntf_cb_ch_update(uint16_t function, uint16_t feature, uint8_t *rx_data, int32_t len)
{
	if(feature == IPC_FEATURE_SOC_REP)
	{
		
	}
	else if(feature == IPC_FEATURE_SOC_REQ)
	{
		switch(rx_data[0])
		{
			case 0xF0:
				if(rx_data[1] == 0x01)
				{	
					DEA_SetResetMagicWord(0);
					if(DEA_GetIpcRecoverFlag() == 1)
					{
						BACKRAM_IPC_FLAG = IPC_MAGIC_VALUE;
					}
					SocReqResetSys(NTF_UPDATE);
					//SysResetWrapper(NTF_UPDATE);
				}
				break;
			case 0xF1:
				if(rx_data[1] == 0x01)
				{	
					rx_data[2] = getITMasterCtrlVerion(); 
					Ic_ipc_gw_send_notification(IPC_CH_UPDATE, function, IPC_FEATURE_IOC_REP, rx_data, 3);
					return;
				}
				break;

			case 0xF2://add by tjy @2019-12-16
				if(rx_data[1] == 0x2f)
				{	
					System_Signal_Send(SYSTEM_SIG_ID_SOC_READY_TO_POWER_OFF, STD_ON, STD_OFF);
					return;
				}
				break;
			
			default:
				break;
		}
		Ic_ipc_gw_send_notification(IPC_CH_UPDATE, function, IPC_FEATURE_IOC_REP, NULL, 0);
	}
}

static void ntf_cb_ch_audio(uint16_t function, uint16_t feature, uint8_t *rx_data, int32_t len)
{
	uint8_t i;
	uint8_t value = 0;
	TracePrintf(IPC_TRACE, TRACE_NONMASK, "[Task_IpcApp]:id:%d stat:%02x\r\n", rx_data[1], rx_data[2]);
	if(feature == IPC_FEATURE_SOC_REP)
	{
		
	}
	else if(feature == IPC_FEATURE_SOC_REQ)
	{
		switch(rx_data[0])
		{
			case 0x84:
				value = rx_data[2];
				if(rx_data[1] == NORMAL_MSG_ID_TurnSoundTi)
				{	
					if(value)
					{
						api_audio_clickclack(AUDIO_CLICK_ACTION);
					}
				}
				else if(rx_data[1] == NORMAL_MSG_ID_TurnSoundTa)
				{	
					if(value)
					{
						api_audio_clickclack(AUDIO_CLACK_ACTION);
					}
				}
				else if((rx_data[1] >= NORMAL_MSG_ID_DoorOpenBuzzer)
					&& (rx_data[1] < NORMAL_BUZZER_ID_MAX))
				{	
					SetBuzzerStatus(rx_data[1],value);//yangxl
					for(i = 0; i < sizeof(s_IpcAudioIdTable)/sizeof(s_IpcAudioIdTable[0]); i++)
					{
						if(rx_data[1] == s_IpcAudioIdTable[i][0])
						{
							if(value)
							{
								api_audio_beep_on_by_id(s_IpcAudioIdTable[i][1]);
							}
							else
							{
								api_audio_beep_off_by_id(s_IpcAudioIdTable[i][1]);
							}
							break;
						}
					}
				}
				break;
			default:
				break;
		}
		Ic_ipc_gw_send_notification(IPC_CH_AUDIO, function, IPC_FEATURE_IOC_REP, NULL, 0);
	}
}


#if 0
void IPC_PM_callback(const void *ctx, uint8 *rx_data, uint32 len)
{
#if 1
	uint8 buff[8] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};

   // SYSTIM  l_curTime;
   // uint16 curTime[2];

    request_context_t *l_ctx = (request_context_t*)ctx;
	
    switch(l_ctx->function_id) 
	{
		
        case IPC_RX_SYS_UPDATE:
            if(l_ctx != NULL)
            {
               // ipc_gw_send_reply(l_ctx, buff, 8);
            }
            System_Signal_Send(SYSTEM_SIG_ID_UPDATE,STD_ACTIVE,STD_OFF);
            break;

	    case IPC_RX_SYS_GETSYSINFO:
             buff[0] = PM_GetCurrentMode();
			 buff[1] = PM_GetAccStatus();
			 buff[2] = PM_GetIgnStatus();
			 buff[3] = PM_GetTcuAccStatus();
			 buff[4] = PM_GetLcdStatus();
			 buff[5] = PM_GetAmpStatus();
             ipc_gw_send_reply(0,l_ctx, buff,8);
             break;

        case IPC_RX_SYS_GETMODE:
             buff[0] = PM_GetCurrentMode();
             ipc_gw_send_reply(0,l_ctx, buff,1);
             break;

		case IPC_RX_GET_ACCSTATUS:
             buff[0] = PM_GetAccStatus();
             ipc_gw_send_reply(0,l_ctx, buff,1);
             break;
			 
		case IPC_RX_GET_IGNSTATUS:
             buff[0] = PM_GetIgnStatus();
             ipc_gw_send_reply(0,l_ctx, buff,1);
             break;
			 
		case IPC_RX_GET_TCUACCSTATUS:
             buff[0] = PM_GetTcuAccStatus();
             ipc_gw_send_reply(0,l_ctx, buff,1);
             break;
		
	    case IPC_RX_GET_LCDSTATUS:
			 buff[0] = PM_GetLcdStatus();
             ipc_gw_send_reply(0,l_ctx, buff,1);
             break;
			 
		case IPC_RX_GET_AMPSTATUS:
			 buff[0] = PM_GetAmpStatus();
             ipc_gw_send_reply(0,l_ctx, buff,1);
             break;	
			 
		case IPC_RX_SET_LCDONOFF:
			 DA_TftBackLightOnOff((*rx_data));
             buff[0] = PM_GetLcdStatus();
             ipc_gw_send_reply(0,l_ctx, buff,1);
             break;
			 
		case IPC_RX_SET_AMPONOFF:
			 DA_AMP_OnOff((*rx_data));
             buff[0] = PM_GetAmpStatus();
             ipc_gw_send_reply(0,l_ctx, buff,1);
             break;	 
		#if 0
        //case IPC_RX_SYS_SETFACTORY:
	    //System_Signal_Send(SYSTEM_SIG_ID_FACTORYRESET,STD_ACTIVE,STD_OFF);		
       // break;

        case IPC_RX_ANIMATION_START:     
		//TracePrintf(IPC_TRACE, TRACE_INFO, "[ipc]Animation Start\n\r");
           // get_tim(&l_curTime);
            //*(uint16 *)&buff[0] = 0x00; //l_curTime.ltime;
            //*(uint16 *)&buff[2] =0x01;// l_curTime.utime;
           // ipc_gw_send_reply(l_ctx,(uint8 *)buff,4);         
	//	System_Signal_Send(SYSTEM_SIG_ID_SOCSTART,1,STD_OFF);			
        break;
        
		case IPC_RX_ANIMATION_END:   
		//TracePrintf(IPC_TRACE, TRACE_INFO, "[ipc]Animation End\n\r");	
       // System_Signal_Send(SYSTEM_SIG_ID_SOCSTART,2,STD_OFF);	
        break;
	   
        //case IPC_RX_CALL_ACTIVE:
		//ipc_gw_send_reply(l_ctx,(uint8 *)buff,1);
      	// System_Signal_Send(SYSTEM_SIG_ID_TEL,STD_ACTIVE,STD_OFF);	
       // break;
        
       // case IPC_RX_CALL_INACTIVE:
	   //	ipc_gw_send_reply(l_ctx,(uint8 *)buff,1);
       //   System_Signal_SetStatus(SYSTEM_SIG_ID_TEL,STD_IDLE);
       // break;    

    	//case IPC_RX_HMI_MODE:
    	//  setHMImode(rx_data[0]);
		//ipc_gw_send_reply(l_ctx,(uint8 *)buff,2);
    	// TracePrintf(IPC_TRACE, TRACE_WARNING, "[ipc]HmiStatus :%d\n\r",rx_data[0]);
    	//break;
		
		case IPC_RX_REVERSE:
		//	TracePrintf(IPC_TRACE, TRACE_INFO, "[ipc]reverseStatus:%d\n\r",rx_data[0]);
		//	if(rx_data[0] == 1)
		//	{
				//DelayMs(200);
		//		System_Signal_SetStatus(SYSTEM_SIG_ID_RVC2SH2,STD_ON);
		//	}
		//	else if(rx_data[0] == 0)
		//	{
		//		System_Signal_SetStatus(SYSTEM_SIG_ID_RVC2SH2,STD_OFF);
		//	}

			break;
		
		case IPC_RX_SYS_PRE_SETFACTORY:
			//setFactoryDefault(TRUE);
			//TracePrintf(IPC_TRACE, TRACE_WARNING, "[ipc]setFactoryDefault\n\r");
			break;
		
		case IPC_RX_SET_USB_PORT:
			//setUsbPower(rx_data[0]);
			//TracePrintf(IPC_TRACE, TRACE_WARNING, "[ipc]setUsbPower:%d\n\r",rx_data[0]);
			break;
		
		case IPC_RX_GET_SYSTEM_TIME:
		//	General_SendIPCGetSysTimeReply(l_ctx, 0);
		//	TracePrintf(IPC_TRACE, TRACE_WARNING, "[ipc]Get Sys Time\n\r");
			break;

		case IPC_RX_GET_BSZ:
		//TracePrintf(IPC_TRACE, TRACE_WARNING, "[ipc]BszStatus:%d\n\r",rx_data[0]);
		//if(rx_data[0] == 1)
		//{
		//	System_Signal_SetStatus(SYSTEM_SIG_ID_BSZ,STD_ON);
		//}
		//else if(rx_data[0] == 0)
		//{
		//	System_Signal_SetStatus(SYSTEM_SIG_ID_BSZ,STD_OFF);
		//}	
			break;

		case IPC_RX_RESTART:
		 	//System_Signal_Send(SYSTEM_SIG_ID_SYSREST,STD_ON,STD_OFF);	
			break;
		#endif
        default:
                break;
   }
#endif
}
#endif

void IPC_SetSocReadyOkFlag(uint8_t flag)
{
	s_SocReadyOkFlag = flag;
}

uint8_t IPC_GetSocReadyOkFlag(void)
{
	return s_SocReadyOkFlag;
}

uint8_t IPC_GetConnectedStatus(void)
{
	return s_IpcConnectedStatus;
}

static void RemoveReqEvent(uint16_t index)
{
	uint8_t l_cnt = 0;
	
	s_event_rm_cnt_f++;
	for(l_cnt = 0; l_cnt < s_EventCnt; l_cnt++)
	{
		if(index == s_EventBuf[l_cnt].seqCnt)
		{
			s_event_rm_cnt++;
			Std_SuspendAllInterrupts();
			if(s_EventCnt == 1)
			{
				s_EventCnt--;
			}
			else
			{
				s_EventCnt--;
				while(l_cnt < s_EventCnt)
				{
					s_EventBuf[l_cnt] = s_EventBuf[l_cnt+1];
					l_cnt++;
				}
			}
			Std_ResumeAllInterrupts();
			//TracePrintf(IPC_TRACE,0,0,0, "rm %d\r\n", index);
			break;
		}
	}
}

static void RemoveReqEventChCan(uint16_t index)
{

}


void SentReqEvent(uint8_t *buf, uint8_t len)
{
	static uint16_t s_indexCnt = 0U;
	uint8_t l_cnt = 0, l_exist = 0U;
	s_indexCnt++;
	
	s_start = xTaskGetTickCount();


	if(s_EventCnt >= IPC_APP_EVENT_SIZE)
	{
#if (STD_ON == TASK_IPCAPP_DEBUG_TRACE)
		TracePrintf(IPC_TRACE,0,0,0, "[T-IPC]Event Buf Will Over\r\n");
#endif
		return;
	}

	if(len > IPC_EVENT_DATA_BUF_SIZE)
	{
#if (STD_ON == TASK_IPCAPP_DEBUG_TRACE)
				TracePrintf(IPC_TRACE,0,0,0, "[T-IPC]Event data Buf Will Over\r\n");
#endif
		return;
	}

	Std_SuspendAllInterrupts();
	for(l_cnt = 0; l_cnt < s_EventCnt; l_cnt++)
	{
		if(buf[0] == s_EventBuf[l_cnt].data[0])
		{
			l_exist = 1U;
			break;
		}
	}
	Std_ResumeAllInterrupts();
	
	if(l_exist)
	{
		if(memcmp(s_EventBuf[l_cnt].data, buf, len))
		{
			Std_SuspendAllInterrupts();
			s_EventBuf[s_EventCnt].seqCnt = s_indexCnt;
			memcpy(s_EventBuf[s_EventCnt].data, buf, len);
			s_EventBuf[s_EventCnt].data_len = len;
			s_EventBuf[s_EventCnt].timerCnt = 100;	//100*10 = 1S
			
			s_EventCnt++;
			Std_ResumeAllInterrupts();
			
			Ic_ipc_gw_send_notification(IPC_CH_REQ, s_indexCnt, IPC_FEATURE_IOC_REQ, buf, len);
		}
	}
	else
	{
		Std_SuspendAllInterrupts();
		s_EventBuf[s_EventCnt].seqCnt = s_indexCnt;
		memcpy(s_EventBuf[s_EventCnt].data, buf, len);
		s_EventBuf[s_EventCnt].data_len = len;
		s_EventBuf[s_EventCnt].timerCnt = 100;	//100*10 = 1S
		
		s_EventCnt++;
		Std_ResumeAllInterrupts();
		
		Ic_ipc_gw_send_notification(IPC_CH_REQ, s_indexCnt, IPC_FEATURE_IOC_REQ, buf, len);
	}
	
}



void SentReqEventChCan(const uint8_t *buf, uint8_t len, uint8_t insertToBufFlag)
{
	static uint16_t s_indexCnt = 0U;
	s_indexCnt++;
	
	if(ipc_gw_is_ch_connected(IPC_CH_CAN))
	{
		Ic_ipc_gw_send_notification(IPC_CH_CAN, s_indexCnt, IPC_FEATURE_IOC_NTF, buf, len);
	}
}

void PutCanMsgToIPC(uint8_t id, const uint8_t *buf, uint8_t len)
{
	uint8_t can_buf[9] = {0};

	can_buf[0] = id;
	memcpy(can_buf+1, buf, len);
	SentReqEventChCan(can_buf, len+1, 0);
}

void PutMultCanMsgToIPC(const uint8_t *buf, uint8_t len)
{
	SentReqEventChCan(buf, len, 0);
}

uint8_t IPC_SendDiagRequest(uint16_t did)
{
	uint8_t buf[4];
	if(ipc_gw_is_ch_connected(IPC_CH_CAN))
	{
		buf[0] = FUN_ID_DIAG_SIG;
		buf[1] = 0x01;
		buf[2] = (did>>8)&0xFF; 
		buf[3] = did&0xFF;
		Ic_ipc_gw_send_notification(IPC_CH_CAN, 0, IPC_FEATURE_IOC_NTF, buf, 4);

		//Task_IpcSemPost();
		return 0;
	}
	else
	{
		return 1;
	}
}

IPC_APP_DIAG_BUF_STRU *IPC_GetDiagDataPtr(void)
{
	return &s_DiagDataBuf;
}

IPC_APP_DIAG_L351_BUF_STRU *IPC_GetDiagL351DataPtr(void) /* yangxl */
{
	return &s_DiagL351DataBuf;
}


void ReqEventProc(void)
{
	uint8_t l_cnt = 0;
	uint8_t l_send_flag = 0;	//indicate one frame already send
	uint16_t l_eventCnt = s_EventCnt;
	
	if(l_eventCnt > 0)
	{
		for(l_cnt = 0; l_cnt < l_eventCnt; l_cnt++)
		{
			if(s_EventBuf[l_cnt].timerCnt > 0)
			{
				s_EventBuf[l_cnt].timerCnt--;
			}
			else
			{	
				if(l_send_flag == 0)	//Haven't send one frame
				{
#if (STD_ON == TASK_IPCAPP_DEBUG_TRACE)
					TracePrintf(IPC_TRACE,0,0,0, "[T-IPC]Event Timeout\r\n");
#endif
					Ic_ipc_gw_send_notification(IPC_CH_REQ, s_EventBuf[l_cnt].seqCnt, IPC_FEATURE_IOC_REQ, s_EventBuf[l_cnt].data, s_EventBuf[l_cnt].data_len);
					//s_EventBuf[l_cnt].timerCnt = 100;	//200*10 = 2S
					RemoveReqEvent(s_EventBuf[l_cnt].seqCnt);
					//s_EventCnt--;
					l_send_flag = 1U;
				}
			}
		}
	}
}


void InitWarnMsgRing(MSG_RING_STRU *p_msgRing, IPC_APP_MSG_STRU *buf, uint8_t size)
{
	p_msgRing->msgBuf = buf;
	p_msgRing->head = 0;
	p_msgRing->tail = 0;
	p_msgRing->size = size;
}

uint8_t IsMsgRingFull(MSG_RING_STRU *p_msgRing)
{
	return ((p_msgRing->tail+ 1) % p_msgRing->size == p_msgRing->head);
}

MSG_RING_STRU *GetMsgRing(uint8_t msgType)
{
	if(msgType == TYPE_MSG_WARN)
	{
		return &s_warnMsgRing;
	}
	else
	{
		return &s_normalMsgRing;
	}
}

void IPC_PutAlarmMsg(NORMAL_MSG_ID_ENUM id, /* message id,eg  NORMAL_MSG_ID_LowFuel*/
			TELLTALE_ENUM TelltaleStatus, /* Telltale Status, eg OFF, ON, Flash 1HZ, Flash 3Hz */	
			ICON_STAT_ENUM  LcdStatus, 	/* Lcd PopUp Status, eg OFF, ON */
			ACOUSTIC_STAT_ENUM Acoustic)	/* Acoustic Alarm Status, eg OFF, ON */
{
	IPC_APP_NORMAL_MSG_STRU l_msg;
	l_msg.ID = id;
	l_msg.Acoustic = Acoustic;
	l_msg.LcdStatus = LcdStatus;
	l_msg.TelltaleStatus = TelltaleStatus;
	PutToMsgRing(TYPE_MSG_NORMAL, (IPC_APP_MSG_STRU *)&l_msg);
}

//msgType: TYPE_MSG_WARN or TYPE_MSG_NORMAL
uint8_t PutToMsgRing(uint8_t msgType, IPC_APP_MSG_STRU *p_warnMsg)
{
	MSG_RING_STRU *p_msgRing = NULL;
	IPC_APP_MSG_STRU warnMsg = *p_warnMsg;
	
	#if (STD_ON == TASK_IPCAPP_DEBUG_TRACE)
	TracePrintf(IPC_TRACE,0,0,0, "[T-IPC]W:%d\r\n", p_warnMsg->ID);
	#endif
	p_msgRing = GetMsgRing(msgType);
	
	portENTER_CRITICAL();
	if((p_msgRing->size == 0) || IsMsgRingFull(p_msgRing))
	{
		portEXIT_CRITICAL();
		return IPC_APP_RET_FAILED;
	}
	else
	{
		p_msgRing->msgBuf[p_msgRing->tail] = warnMsg;
		p_msgRing->tail = (p_msgRing->tail + 1) % p_msgRing->size;
		portEXIT_CRITICAL();
		return IPC_APP_RET_OK;
	}
}

uint8_t GetMsgRingSize(MSG_RING_STRU *p_msgRing)
{
	uint8_t size = 0;
	portENTER_CRITICAL();
	if(p_msgRing->tail >= p_msgRing->head)
	{
		size = p_msgRing->tail - p_msgRing->head;
	}
	else
	{
		size = p_msgRing->size - p_msgRing->head + p_msgRing->tail;
	}
	portEXIT_CRITICAL();
	return size;
}

uint8_t readFromRingToBuf(MSG_RING_STRU *p_msgRing, uint8_t *buf, uint8_t count)
{
	int i = 0;
	portENTER_CRITICAL();
	for(i = 0; i < count; i++)
	{
		memcpy(buf+i*sizeof(p_msgRing->msgBuf[0]), &p_msgRing->msgBuf[p_msgRing->head], sizeof(p_msgRing->msgBuf[0]));
		p_msgRing->head = (p_msgRing->head + 1) % p_msgRing->size;
	}
	portEXIT_CRITICAL();
	return IPC_APP_RET_OK;
}

void SendTimeInfoToSoc(void)
{
	uint8_t buf[10] = {0};
	buf[0]= FUN_ID_TIME_INFO_MSG;
	buf[1]= 0x03;

	memset(&buf[2], 0, 8);
	memcpy(&buf[2], s_sysTimeInfoMsg.Time, 7);
	SentReqEvent(buf, 10);
}

void SendSelfDiagStaticToSoc(void)
{
	uint8_t buf[2+sizeof(s_SelfDiagStatic)] = {0};
	buf[0]= FUN_ID_SELF_DIAG_S;
	buf[1]= 0x03;

	s_SelfDiagStatic.Rm1 = VEL_Rm1/1000;
	s_SelfDiagStatic.Rm2 = VEL_Rm2/1000;
	s_SelfDiagStatic.Rc = VEL_Rc;
	s_SelfDiagStatic.DR = 50;
	s_SelfDiagStatic.SM = 500;
	memcpy(&buf[2], &s_SelfDiagStatic, sizeof(s_SelfDiagStatic));
	Ic_ipc_gw_send_notification(IPC_CH_NTF, 0, IPC_FEATURE_IOC_NTF, buf, sizeof(s_SelfDiagStatic)+2);
}

void SendMeterBasicInfoToSoc(void)
{
	extern const uint8 gIocSWVersion[];	//generated by tool
	extern const uint16 EA_VERSION;
	
	uint8_t buf[100] = {0};
	char *p_str = NULL;
	uint8_t str_buf[20] = {0};
	uint8_t l_str_len = 0;
	
	buf[0]= FUN_ID_BASIC_INFO;
	buf[1]= 0x01;

	p_str = pvPortMalloc(100);
	if(p_str == NULL)
	{
		return;
	}
	
	memset(p_str, 0, 100);
	IC_sid0x22ReadSparePartsNumNissan(0, str_buf);
	sprintf(&buf[2]+l_str_len, "%s\n", str_buf);				//Part No
	
	l_str_len = strlen(&buf[2]);
	sprintf(&buf[2]+l_str_len, "%s\n", gIocSWVersion);			//Software version No
	
	l_str_len = strlen(&buf[2]);
	sprintf(&buf[2]+l_str_len, "S%02d\n", getCircuitVerion());	//Hardware version No
	
	l_str_len = strlen(&buf[2]);
	sprintf(&buf[2]+l_str_len, "%02d\n", EA_VERSION);			//EEPROM version No
	
	l_str_len = strlen(&buf[2]);
	sprintf(&buf[2]+l_str_len, "S%02d", getCircuitVerion());	//PCB Version No

	vPortFree(p_str);
	l_str_len = strlen(&buf[2]);	
	Ic_ipc_gw_send_notification(IPC_CH_NTF, 0, IPC_FEATURE_IOC_NTF, buf, l_str_len+2+1);
}

void Ntf_CbProc(uint16_t function, uint8_t *data, uint16_t len)
{
	SystemTaskMsgInfoType l_message;
	static uint8_t s_sys_set_write_trigger_flag = 0;
	uint8_t buf[6] = {0};
	//static uint8_t s_dimm_step = 0xFF;
	uint16_t l_u16Value = *((uint16_t *)(&data[2]));
	memcpy(buf, data, 3);
	switch(data[0])
	{
		case FUN_ID_SOC_SET_MSG:		/* Soc Setting */
			switch(data[1])
			{
				#if 0
				case IPC_SOC_SET_backLightValue:
					TracePrintf(IPC_TRACE,0,0,0, "[T-IPC][VehicleBrightness]:%d\r\n", data[2]);
					if(data[2] > 15)
					{
						if(s_dimm_step != 15)
						{
							s_dimm_step = 15;
							//System_Signal_SetStatus(SYSTEM_SIG_ID_DIMMING_STEP, 15, STD_OFF);
						}
					}
					else
					{
						if(s_dimm_step !=  data[2])
						{
							s_dimm_step = data[2];
							//System_Signal_SetStatus(SYSTEM_SIG_ID_DIMMING_STEP, data[2], STD_OFF);
						}
					}
					SysSettingbackLightValueSet(s_dimm_step);
					break;
				case IPC_SOC_SET_maintenanceMileage:
					if(data[2] == 0)
					{
						ServAlarmFunctionFlagSet(0);
					}
					else
					{
						ServAlarmFunctionFlagSet(1);
					}
					SysSettingMaintenanceMileageSet(l_u16Value);
					break;
				#endif
				case IPC_SOC_COMMAND_lcdPower:
					if(data[2] == 0x01)
					{
						System_Signal_Send(SYSTEM_SIG_ID_LCD, STD_ON, STD_OFF);
					}
					else
					{
						System_Signal_Send(SYSTEM_SIG_ID_LCD, STD_OFF, STD_OFF);
					}
					break;
				case IPC_SOC_COMMAND_resetTrip:
					TracePrintf(IPC_TRACE,0,0,0, "[T-IPC]TripReset:%d\r\n", data[2]);
					if(data[2] == 0x01)
					{
						ODO_ResetTripA();
						AVS_ResetTripAAVS();
						AFC_vResetA();
					}
					else if(data[2] == 0x02)
					{
						ODO_ResetTripB();
						AVS_ResetTripBAVS();
						AFC_vResetB();
					}
					break;
				case IPC_SOC_COMMAND_resetAverageFuel:
					Afc_vReset();
					//AFC_vResetA();
					//AFC_vResetB();
					break;
				case IPC_SOC_COMMAND_resetAverageSpeed:
					//AVS_ResetTripAAVS();
					//AVS_ResetTripBAVS();
					break;
				case IPC_SOC_COMMAND_updateReq:
					#if (STD_ON == TASK_IPCAPP_DEBUG_TRACE)
					TracePrintf(IPC_TRACE,TRACE_WARNING,0,0, "[T-IPC]UpdateSysReq:%d\r\n", data[2]);
					#endif
					sid0x31IpcUpdater();
					break;
				case IPC_SOC_COMMAND_sysOnorOff:
					#if (STD_ON == TASK_IPCAPP_DEBUG_TRACE)
					TracePrintf(IPC_TRACE,0,0,0, "[T-IPC]SysOnOff:%d\r\n", data[2]);
					#endif
					break;
				#if 0
				case IPC_SOC_SET_speedLimit:
					TracePrintf(IPC_TRACE,0,0,0, "[T-IPC]Speed Limit:%d\r\n", data[2]);
					VEL_LT_SetValue(data[2]);
					SysSettingSpeedLimitSet(l_u16Value);
					break;
				case IPC_SOC_SET_hmiLastPage:
					TracePrintf(IPC_TRACE,0,0,0, "[T-IPC]HmiLastPage:%d\r\n", data[2]);
					//HMI_CfgLastPageSet(data[2]);
					SysSettingHmiLastPageSet(l_u16Value);
					break;
				/*case IPC_SOC_SET_:
					TracePrintf(IPC_TRACE,0,0,0, "[T-IPC]BuzzerOnOff:%d\r\n", data[2]);
					//Port_SpeakSw_Pin(PORT_SET_VALUE, !data[2]);
					break;*/
				#endif
				case IPC_SOC_COMMAND_socReady:
					IPC_SetSocReadyOkFlag(1);
					SysSettingUpFlagSet(1);
					semiActiveUpdateFlagSet(1);
					DEA_SetCanMsgtoIpcInitFlag(0);	
					System_Signal_Send(SYSTEM_SIG_ID_SOCUPDATARTC, STD_ON, STD_OFF);//STD_ON
					s_hardware_state = 0;
					s_power_on_update_flag = 1;
					s_IpcConnectedStatus = 1;
					break;
				case IPC_SOC_COMMAND_resetFuelCap:
					DEA_SetFuelCapReset(1);
					break;
				case IPC_SOC_COMMAND_HistoryFuelReset:
					//ReSet_HAFC();
					ReSetHisAfc();//yangxl
					break;
				case IPC_SOC_COMMAND_HistoryFuelUpdate:
					//Update_BestAfc();
					//s_UpdateBestHisFuelFlag = 1;
					UpdateBestAfc();//yangxl
					break;
				case IPC_SOC_COMMAND_FactoryReset:
					SysSettingFactoryReset();
					break;
				case IPC_SOC_COMMAND_IdleStopCumulativeReset:
					IDLE_FUEL_CumulativeReset();
					break;
				case IPC_SOC_COMMAND_IdleStopTripReset:
					IDLE_FUEL_TripReset();
					break;
				case IPC_SOC_COMMAND_AudioOnOff:
					/*TracePrintf(IPC_TRACE, TRACE_NONMASK, "[Task_IpcApp]:AudioOnOff %d\r\n", l_u16Value);
					if(l_u16Value)
					{
						api_audio_mute_beep(0);
					}
					else
					{
						api_audio_mute_beep(1);
					}*/
					break;
				case IPC_SOC_COMMAND_SonarDisplayCancel:
					CanApp_TxSonarCancelRequest();
					break;
				case IPC_SOC_COMMAND_Illumination:
					if(l_u16Value > 1000) //%0.1
					{
						l_u16Value = 1000;
					}
					
					if(s_ipc_debug_flag)
					{
						TracePrintf(IPC_TRACE, TRACE_NONMASK, "[Task_IpcApp]:Illumination %d\r\n", l_u16Value);
					}
					
					if(semiActiveIndirectIlluminationGet())
					{
						illumination_output(l_u16Value);
					}
					break;
				case IPC_SOC_COMMAND_SelfDiagModeSwitch:
					if(l_u16Value == 1)
					{
						SendSelfDiagStaticToSoc();
						SendMeterBasicInfoToSoc();
					}
					break;
				case IPC_SOC_COMMAND_MeterBasicInfo:
					if(l_u16Value == 1)
					{
						SendMeterBasicInfoToSoc();
					}
					break;
				case IPC_SOC_COMMAND_VehicleReset:
					SysSettingVehicleReset();
					break;
				case IPC_SOC_COMMAND_HudReset: //yangxl 2019-12-23 10:58:27
					{
						SettingHudReset();
						break;
					}
				case IPC_SOC_COMMAND_MeterReset: //yangxl 2019-12-23 10:58:27
					{
						SettingMeterReset();
						break;
					}
				default: 
					TracePrintf(IPC_TRACE,0,0,0, "[T-IPC]Unknow:%u %d\r\n", data[1], data[2]);
					break;
			}	
			data[2] = 1;	//state byte, value 1 is success
			buf[0] = data[0];
			buf[1] = data[1];
			buf[2] = 1;
			if(len >= sizeof(buf))
			{
				len = 3;
			}
			else if(len >= 2)
			{
				memcpy(&buf[3], &data[2], len-2);
				len += 1;
			}
			Ic_ipc_gw_send_notification(IPC_CH_REQ, function, IPC_FEATURE_IOC_REP, buf, len);
			break;
		case FUN_ID_SOC_SYSTEM_SET_MSG:	/* Soc System Setting */
			if((data[1] >= IPC_SOC_SETTING_language) && (data[1] <= IPC_SOC_SETTING_UPASwitch))
			{
				#if (STD_ON == TASK_IPCAPP_DEBUG_TRACE)
				TracePrintf(IPC_TRACE, TRACE_NONMASK, "[T-IPC]%d:%d\r\n", data[1], data[2]);
				#endif
				if(SysSettingFuncList[data[1]-1])
				{
					SysSettingFuncList[data[1]-1](l_u16Value);
				}
				if(s_sys_set_write_trigger_flag == 0)
				{
					s_sys_set_write_trigger_flag = 1;
					NvM_SetRamBlockStatus(g_sys_settingNvMBlockID, s_sys_set_write_trigger_flag);
				}
			}
			else
			{	
				#if (STD_ON == TASK_IPCAPP_DEBUG_TRACE)
				TracePrintf(IPC_TRACE, TRACE_NONMASK,"[T-IPC]Unknow:%u %d\r\n", data[1], data[2]);
				#endif
			}
			data[2] = 1;	//state byte, value 1 is success
			buf[0] = data[0];
			buf[1] = data[1];
			buf[2] = 1;
			if(len >= sizeof(buf))
			{
				len = 3;
			}
			else if(len >= 2)
			{
				memcpy(&buf[3], &data[2], len-2);
				len += 1;
			}
			Ic_ipc_gw_send_notification(IPC_CH_REQ, function, IPC_FEATURE_IOC_REP, buf, len);
			break;
		case FUN_ID_DIAG_SIG:
			if(len > 2)
			{
				memset(&s_DiagDataBuf, 0, sizeof(s_DiagDataBuf));
				memcpy(&s_DiagDataBuf, &data[2], len-2);
				//Task_IpcSemPost();
				l_message.msgId = SYSTEM_SIG_ID_DIAGREQSOC;
				l_message.parBufPtr = NULL;
				l_message.size = 0;
				System_Task_SendMessage(SYSTEM_TASK_ID_DIAG, &l_message, false);
			}
			Ic_ipc_gw_send_notification(IPC_CH_REQ, function, IPC_FEATURE_IOC_REP, NULL, 0);
			break;
		case FUN_ID_DIAG_L351_SIG: /* yangxl */
			if(len > 2)
			{
				memset(&s_DiagL351DataBuf, 0, sizeof(s_DiagL351DataBuf));
				memcpy(&s_DiagL351DataBuf, &data[2], len-2);
				//Task_IpcSemPost();
				/*
				l_message.msgId = SYSTEM_SIG_ID_DIAGREQSOC;
				l_message.parBufPtr = NULL;
				l_message.size = 0;
				System_Task_SendMessage(SYSTEM_TASK_ID_DIAG, &l_message, false);
				*/
				//TracePrintf(COM_TRACE, TRACE_NONMASK, "[Diag_DID_0x0351]:data \r\n"); /*yangxl*/
			}
			//Ic_ipc_gw_send_notification(IPC_CH_REQ, function, IPC_FEATURE_IOC_REP, NULL, 0);	//not neeed
			break;
		default:
			Ic_ipc_gw_send_notification(IPC_CH_REQ, function, IPC_FEATURE_IOC_REP, NULL, 0);
			break;
	}
}

uint8_t Is_CanTimeoutChanged(uint8_t *buf1, uint8_t *buf2, uint8_t size)
{
	if(memcmp(buf1, buf2, size))
	{
		return 1;
	}
	else
	{
		return 0;
	}
}

uint8_t Is_IdleStopInfoChanged(IPC_APP_IDLE_STOP_INFO_STRU *pIdleStopInfo)
{
	if((DEA_GetFilterfuelCumulativeValue() != pIdleStopInfo->IdleStopFuelA)
				||(DEA_GetFilterfuelLtripValue() != pIdleStopInfo->IdleStopFuelB)
				||(DEA_GetFilterCumulativeValue_H() != pIdleStopInfo->IdleStopTimeA[0])
				||(DEA_GetFilterCumulativeValue_M() != pIdleStopInfo->IdleStopTimeA[1])
				||(DEA_GetFilterCumulativeValue_S() != pIdleStopInfo->IdleStopTimeA[2])
				||(DEA_GetFilterlTripValue_H() != pIdleStopInfo->IdleStopTimeB[0])
				||(DEA_GetFilterlTripValue_M() != pIdleStopInfo->IdleStopTimeB[1])
				||(DEA_GetFilterlTripValue_S() != pIdleStopInfo->IdleStopTimeB[2]))
	{
		return 1;
	}
	else
	{
		return 0;
	}
}

#if 0
uint8_t Is_HistoryAvgFuelChanged(IPC_APP_HISTORY_AVG_FUEL_STRU *pHistoryAvgFuel)
{
	HIS_AFC l_his_afc;
	if((DEA_GetFilterHistoryAfcShowValid() != pHistoryAvgFuel->HistoryAvgFuelEconomyFlag)
		||(pHistoryAvgFuel->EcoRankFlag != DEA_GetSFilterEcoRankValid()))
	{
		pHistoryAvgFuel->HistoryAvgFuelEconomyFlag = DEA_GetFilterHistoryAfcShowValid();
		l_his_afc = DEA_GetFilterHistoryAfcValue();
		pHistoryAvgFuel->LastAF1 = l_his_afc.value_one;
		pHistoryAvgFuel->LastAF2 = l_his_afc.value_two;
		pHistoryAvgFuel->LastAF3 = l_his_afc.value_three;
		pHistoryAvgFuel->LastAF4 = l_his_afc.value_four;
		pHistoryAvgFuel->LastAF5 = l_his_afc.value_five;
		pHistoryAvgFuel->LastAF6 = l_his_afc.value_six;
		pHistoryAvgFuel->BestAvgFuelEconomy = DEA_GetFilterBestHistoryAfcValue();
		pHistoryAvgFuel->EcoRankFlag = DEA_GetSFilterEcoRankValid();
		pHistoryAvgFuel->EcoRank = DEA_GetFilterEcoRankValue();
		return 1;
	}
	else
	{
		return 0;
	}
}
#endif

void IPC_SetCanMessageTimeoutStat(uint8_t id, uint8_t stat)
{
	if(stat)
	{
		s_CanMessageTimeoutStat[id / 8] |= (0x01<<(id%8));
	}
	else
	{
		s_CanMessageTimeoutStat[id / 8] &=~(0x01<<(id%8));
	}
}

uint8_t IPC_HardwareProc(uint8_t *buf, uint8_t len)
{
	uint8_t ret = 0;
	uint32_t l_state = 0;
	
	if(len < 4)
	{
		return 0;
	}

	l_state =  ((uint32_t)(Port_GetPinLevel(IOC_CHARGE)&0x01))<<HARD_CHARGE_SIGNAL_ForIdleStop;	//PTC30
	l_state |= ((uint32_t)(GetPinValue_IOC_BRAKE_OIL()&0x01))<<HARD_BRAKE_OIL_SW_ForIndicator;
	l_state |= ((uint32_t)(GetPinValue_IOC_PKB()&0x01))<<HARD_PKB_SW_ForWarningLamp;
	l_state |= ((uint32_t)(GetPinValue_IOC_DR_SAFETY_BELT_WARNING()&0x01))<<HARD_SEAT_BELT_DR_CPU_READ;
	l_state |= ((uint32_t)(GetPinValue_IOC_AS_SAFETY_BELT_WARNING()&0x01))<<HARD_SEAT_BELT_AS_CPU_READ;
	l_state |= ((uint32_t)(GetPinValue_IOC_SECURITY()&0x01))<<HARD_SECURITY_Signal;
	l_state |= ((uint32_t)(!(GetPinValue_IOC_CHARGE_CONNECT_DETECT()&0x01)))<<HARD_ChargeConnectDetect;
	l_state |= ((uint32_t)(GetPinValue_IOC_LED_HEAD_LAMP_L()&0x01))<<HARD_LED_HEAD_LAMP_L;
	l_state |= ((uint32_t)(GetPinValue_IOC_LED_HEAD_LAMP_R()&0x01))<<HARD_LED_HEAD_LAMP_R;
	l_state |= ((uint32_t)(GetPinValue_IOC_PKB()&0x01))<<HARD_PKB_SW_ForSignalBuffer;
	
	if(l_state != s_hardware_state)
	{
		DEA_SetHardwareStatus(l_state);
		s_hardware_state = l_state;
		
		/*buf[0] = l_state>>24;
		buf[1] = l_state>>16;
		buf[2] = l_state>>8;
		buf[3] = l_state;*/
		*((uint32_t *)buf) = l_state;
		ret = 1;
	}
	return ret;
}

void IPC_SetPredriveCheckStatus(uint8_t status)
{
	s_sysCtrl.PredriveCheck = status;
}

void SysTimeUpdatSoc(uint16 Y,uint8 Month,uint8 Day,uint8 Hour,uint8 Min,uint8 Sec,uint8 Format)
{
	s_sysTimeInfoMsg.Time[0] = (uint8)(Y-2000);
	s_sysTimeInfoMsg.Time[1] = Month;
	s_sysTimeInfoMsg.Time[2] = Day;
	s_sysTimeInfoMsg.Time[3] = Hour;
	s_sysTimeInfoMsg.Time[4] = Min;
	s_sysTimeInfoMsg.Time[5] = Sec;
	s_sysTimeInfoMsg.Format = Format;
	s_timeUpdateFlag = 1;
}


IPC_APP_TIME_INFO_STRU IPC_GetsysTimeInfo(void)
{
	return s_sysTimeInfoMsg;
}

#if 0
void IPC_SetHistoryAvgFuel(uint16_t value_one, uint16_t value_two,uint16_t value_three,uint16_t value_four,uint16_t value_five,
										uint16_t value_six, uint16_t BestHistoryAfcValue)
{
	IPC_APP_HISTORY_AVG_FUEL_STRU *pHistoryAvgFuel = &s_HistoryAvgFuel;
	pHistoryAvgFuel->LastAF1 = value_one;
	pHistoryAvgFuel->LastAF2 = value_two;
	pHistoryAvgFuel->LastAF3 = value_three;
	pHistoryAvgFuel->LastAF4 = value_four;
	pHistoryAvgFuel->LastAF5 = value_five;
	pHistoryAvgFuel->LastAF6 = value_six;
	pHistoryAvgFuel->BestAvgFuelEconomy = BestHistoryAfcValue;
	//pHistoryAvgFuel->EcoRankFlag = DEA_GetSFilterEcoRankValid();
	//pHistoryAvgFuel->EcoRank = DEA_GetFilterEcoRankValue();
}
#endif
void SelfDiagDynamicStatusProc(IPC_SELF_DIAG_DYNAMIC_STRU *pSelfDiagDynamic)
{
	static uint8_t s_taco3EC_received_flag = 0;
	/*
	if(DEA_GetCanTimeOutStat(IPDU_HND_Front_Wheel_Speed_Frame) == 1)
	{
		pSelfDiagDynamic->ErrorCode0 = 1;
	}
	else if(DEA_GetRawVehicleSpeedErrorStat() == 1)
	{
		pSelfDiagDynamic->ErrorCode0 = 2;
	}
	else
	{
		pSelfDiagDynamic->ErrorCode0 = 0;
	}
	*/
	if(pSelfDiagDynamic->ErrorCode0 != 1)
	{
		if(DEA_GetCanTimeOutStat(IPDU_HND_Front_Wheel_Speed_Frame) == 1)
		{
			pSelfDiagDynamic->ErrorCode0 = 1;
		}
		else if(DEA_GetRawVehicleSpeedErrorStat() == 1)
		{
			pSelfDiagDynamic->ErrorCode0 = 2;
		}
	}
	
#if 0
	if(s_taco3EC_received_flag == 1)
	{
		#if 0
		if(DEA_GetCanTimeOutStat(IPDU_HND_ATCVT_to_MMI_N1) == 1)
		{
			pSelfDiagDynamic->ErrorCode1 = 1;
		}
		else
		{
			pSelfDiagDynamic->ErrorCode1 = 0;
		}
		#endif
	}
	else 
	{
		#if 0
		if(DEA_GetCanTimeOutStat(IPDU_HND_ATCVT_to_MMI_N1) == 0)
		{
			s_taco3EC_received_flag = 1;
			pSelfDiagDynamic->ErrorCode1 = 0;
		}
		else
		{
			if(DEA_GetCanTimeOutStat(IPDU_HND_ECM_TorqueControl_RN1) == 1)
			{
				pSelfDiagDynamic->ErrorCode1 = 1;
			}
			else
			{
				pSelfDiagDynamic->ErrorCode1 = 0;
			}
		}
		#endif
	}
#endif

	if(DEA_GetCanTimeOutStat(IPDU_HND_ECM_TorqueControl_RN1) == 1)
	{
		pSelfDiagDynamic->ErrorCode1 = 1;
	}
	/*
	else
	{
		pSelfDiagDynamic->ErrorCode1 = 0;
	}
	*/

	if(pSelfDiagDynamic->ErrorCode2 != 1)
	{
		if(FUEL_GetFuelSigStatus() == FuelSigShort)
		{
			pSelfDiagDynamic->ErrorCode2 = 1;
		}
		else if(FUEL_GetFuelSigStatus() == FuelSigOpen)
		{
			pSelfDiagDynamic->ErrorCode2 = 2;
		}
	}
	/*
	if(FUEL_GetFuelSigStatus() == FuelSigShort)
	{
		pSelfDiagDynamic->ErrorCode2 = 1;
	}
	else if(FUEL_GetFuelSigStatus() == FuelSigOpen)
	{
		pSelfDiagDynamic->ErrorCode2 = 2;
	}
	else
	{
		pSelfDiagDynamic->ErrorCode2 = 0;
	}
	*/

	if(DEA_GetCanTimeOutStat(IPDU_HND_ECM_GeneralStatus) == 1)
	{
		pSelfDiagDynamic->ErrorCode3 = 1;
	}
	/*
	else
	{
		pSelfDiagDynamic->ErrorCode3 = 0;
	}
	*/

	pSelfDiagDynamic->FuelIgad = 1022;
	pSelfDiagDynamic->FuelFmad = DEA_GetFMAD();
	pSelfDiagDynamic->FGAUGE = DEA_GetFGAUGE();
	pSelfDiagDynamic->FuelSensor = FUEL_GetFuelSensorResNow();
	
	pSelfDiagDynamic->RAFV = Get_R_AFV_Value()/10000;
	pSelfDiagDynamic->RAFC = Get_R_AFC_Value();
	if(Get_DteState() < DTE_DIS_SECOND)
	{
		if(DEA_GetDTE() >= 50)
		{
			pSelfDiagDynamic->DTE_Values = DEA_GetDTE();
		}
		else
		{
			pSelfDiagDynamic->DTE_Values = 0;
		}
	}
	else
	{
		pSelfDiagDynamic->DTE_Values = 0;
	}
}

/**************************************************************************** 
Function	:         
Input		:          
Output		:         
Return		:  
Author	    : yangxl
Description :        
Date  		: 2020-5-8 14:23:05
*****************************************************************************/
void ClearSelfDiagErrorCodeProc(IPC_SELF_DIAG_DYNAMIC_STRU *pSelfDiagDynamic)
{
	pSelfDiagDynamic->ErrorCode0 = 0;
	pSelfDiagDynamic->ErrorCode1 = 0;
	pSelfDiagDynamic->ErrorCode2 = 0;
	pSelfDiagDynamic->ErrorCode3 = 0;
	pSelfDiagDynamic->ErrorCode4 = 0;
	pSelfDiagDynamic->ErrorCode5 = 0;
	pSelfDiagDynamic->ErrorCode6 = 0;
	
}


void IPC_SetDebugFlag(uint8_t stat)
{
	s_ipc_debug_flag = stat;
}

void IPC_SetCarBodySetInProgress(uint8_t stat)
{
	uint8_t buf[4];
	if(CarBodySetInProgress != stat)
	{
		CarBodySetInProgress = stat;
		buf[0]	= FUN_ID_IOC_SET_MSG;
		buf[1]	= IPC_IOC_COMMAND_CarBodySetInProgress;
		buf[2] 	= stat;
		buf[3] 	= 0;
		//call tx routine
		if(ipc_gw_is_ch_connected(IPC_CH_REQ))
		{
			SentReqEvent(buf, 4);
		}		
	}
}

void IPC_SetResetHisFuelFlag(uint8_t value)
{
	s_ResetHisFuelFlag = value;
}

void IPC_UpdateFuelState(uint8_t fill_stat, uint16_t fuel_now, uint16_t fuel_save)
{
	s_IocStat.FuelFillMode = fill_stat;
	s_IocStat.FuelIgnOn = fuel_now;
	s_IocStat.FuelSave = fuel_save;
	//s_IocStat.dte30sflg = 0;
	s_IocStatUpdate_flag = 1;
}

void IPC_UpdateDTEState(uint32_t r_afc, uint32_t r_afv,uint16_t dte_disp,uint16_t dte_cal) //Yangxl 2019-11-11 17:21:27
{
	s_IocStat.r_afc = r_afc;
	s_IocStat.r_afv = r_afv;
	s_IocStat.dte_disp = dte_disp;
	s_IocStat.dte_cal = dte_cal;
	//s_IocStat.FuelSave = fuel_save;
	//s_IocStat.dte30sflg = 1;
	//s_IocStatUpdate_flag = 1;
	s_IocDteStatUpdate_flag = 1;
}


void Task_IpcAppInit(void)
{
	InitWarnMsgRing(&s_warnMsgRing , s_WarnMsgBuf, sizeof(s_WarnMsgBuf)/sizeof(s_WarnMsgBuf[0]));
	InitWarnMsgRing(&s_normalMsgRing , s_normalMsgBuf, sizeof(s_normalMsgBuf)/sizeof(s_normalMsgBuf[0]));
}

extern BACKRAM_START_SEC_VAR_UNSPECIFIED uint32 g_BootLoaderJumpCmd;
void Task_IpcApp(void * pvParameters)
{
	//boolean l_returnValue = E_NOT_OK;
	//SystemTaskMsgInfoType l_msgInfo = {0XFFFF, 0U, NULL};
	
	uint32_t 				xLastWakeTime;
	uint32_t 				l_times = 0, l_time_pos = 0;
	uint8_t 				buf[256];
	IPC_APP_BUTTON_STRU 	l_buttonMsg = {0};
	//IPC_APP_SYS_SET_STRU 	l_sysSetMsg = {0};
	static uint16_t 		min_stack = 0xFFFF;
	static uint8_t 			s_middle_switch_flag = 0;
	static uint8_t 			s_middle_switch_flagavgf = 0;
	uint8_t 				i;
	uint8_t 				msg_size;
	uint32_t 				xlastCount;
	uint32_t 				l_WaitSocReadyCnt = 0;
	uint8_t 				l_eventCnt = 0U, l_changeCnt = 0U;
	//uint16 s_DiagIoTemp;
	uint8_t 				l_soc_ready_flag  = 0;
	uint8_t					l_power_changed_flag = 0;
	uint8_t 				l_CanMessageTimeoutBuf[IPC_EVENT_DATA_BUF_SIZE] = {0};

	//static uint8_t 			s_leftSeatBelt = 0;
	//static uint8_t 			s_MiddleSeatBelt = 0;
	//static uint8_t 			s_RightSeatBelt = 0;
	static uint8_t 			s_TravelTime_Hour = 0;
	static uint8_t 			s_TravelTime_Minute = 0;
	static uint8_t 			s_TravelTime_Second = 0;
	static uint8_t			s_IgnBackForHisAfc = IGN_OFF;
	static IGN_STAT_ENUM	s_IgnStatusBak = 0xFF;
	//static uint32_t 		s_IdleStopFuelA = 0;
	//static uint32_t		s_IdleStopFuelB = 0;
	//static IPC_APP_TIME_STRU s_IdleStopTimeA = {0};
	//static IPC_APP_TIME_STRU s_IdleStopTimeB = {0};
	//IPC_APP_HISTORY_AVG_FUEL_STRU l_HistoryAvgFuel = {0};

	static uint8_t s_PredriveCheckStatus = 0; //yangxl 2020-5-8 16:06:47

	IPC_APP_HISTORY_AFC_STRU l_HisAvgFuelData = {0};

	//uint8_t				 l_power_down_cnt = 0;
	
	/*Warning: You need change the following array's size according to your real length.*/
	//uint8_t l_msgDataBuf[4] = {0U, 0U, 0U, 0U};
#if (STD_ON == TASK_IPCAPP_STACK_MONITOR)
	uint16 l_stackSize = 0U;
#endif

	//l_msgInfo.parBufPtr = &l_msgDataBuf[0];
	/*===============================================================================*/
	/*=============================== START: USER CODE ==============================*/
	/*===============================================================================*/
	/*
	System_Signal_Subscribe(SYSTEM_SIG_ID_XXX, SYSTEM_TASK_ID_IPCAPP);
	System_Signal_SubSpecValue(SYSTEM_SIG_ID_XXX, SYSTEM_TASK_ID_IPCAPP, X);
	*/

	Task_IpcSemCreate();

	ic_ipc_gw_init();

	ic_ipc_gw_register(IPC_CH_REQ, (Spi_notification_callback)ntf_cb_ch_req);
	ic_ipc_gw_register(IPC_CH_NTF, (Spi_notification_callback)ntf_cb_ch_ntf);
	ic_ipc_gw_register(IPC_CH_CAN, (Spi_notification_callback)ntf_cb_ch_can);
	ic_ipc_gw_register(IPC_CH_AUDIO, (Spi_notification_callback)ntf_cb_ch_audio);
	ic_ipc_gw_register(IPC_CH_UPDATE, (Spi_notification_callback)ntf_cb_ch_update);
	
	//DA_ipc_gw_register(IPC_CH_DA_PWR,NULL,IPC_PM_callback);

	xLastWakeTime = xTaskGetTickCount();
	//SysSettingCarBodySetInProgressSet(0);

	/*===============================================================================*/
	/*================================ END: USER CODE ===============================*/
	/*===============================================================================*/
	while (1)
	{
		//vTaskDelay(10U);
		//continue;
		if((IPC_GetSocReadyOkFlag() == 0) && (l_WaitSocReadyCnt < 3000))
		{
			vTaskDelay(10U);
			xLastWakeTime = xTaskGetTickCount();	//update xLastWakeTime every cycle to prevent vTaskDelayUntil execute frequent 
			l_WaitSocReadyCnt++;
			//if 11S past after ioc wake up, not received soc ready, try to reset soc
			if((l_WaitSocReadyCnt >= 1100) && (s_IpcResetSocFlag == 0))	//11S
			{
				INT_SYS_DisableIRQGlobal();
				PowerOff();
				//for(l_power_down_cnt = 0; l_power_down_cnt < 20; l_power_down_cnt++)
				//{
				//	DelayMs(50);
				//}
				DelayMs(1000);
				Ex_Wdg_Refresh();
				g_BootLoaderJumpCmd = JUMP_TO_APP_AT_ONCE;
				s_IpcResetSocFlag = 1;
				SystemSoftwareReset(SOC_NOT_READY, FALSE);
			}
			continue;
		}
		else
		{
			if(l_soc_ready_flag == 0)
			{
				IPC_SetSocReadyOkFlag(1);
				if(ipc_gw_is_ch_connected(IPC_CH_REQ))
				{
					l_soc_ready_flag = 1;
					//SendTimeInfoToSoc(); 
				}
			}
			else 
			{
				if(ipc_gw_is_ch_connected(IPC_CH_REQ) == 0)	//if connect link down, reset l_soc_ready_flag
				{
					l_soc_ready_flag = 0;
				}
			}
		}
		
		l_times++;
		if(l_times >= 100)
		{
			l_times = 0;
		}
		l_time_pos = 0;

		ReqEventProc();
		if(l_eventCnt != s_EventCnt)
		{
			l_eventCnt = s_EventCnt;
			l_changeCnt++;
#if(STD_ON == TASK_IPCAPP_DEBUG_TRACE)
			TracePrintf(IPC_TRACE,0,0,0, "[T-IPC]Event Chage %d T:%d %d %d\r\n", s_EventCnt, l_changeCnt,s_event_rm_cnt_f, s_event_rm_cnt);
#endif
		}

		if(semiActiveUpdateFlagGet() != 0)
		{
			semiActiveUpdateFlagSet(0);
			s_sysSemiSetMsg.TPMSWith = semiActiveTPMSWithGet();
			s_sysSemiSetMsg.ClockWithoutNavi_Audio = semiActiveClockWithoutNavi_AudioGet();
			s_sysSemiSetMsg.NAVI_AUDIO = semiActiveNAVI_AUDIOGet();
			s_sysSemiSetMsg.ITS_BSW = semiActiveITS_BSWGet();
			s_sysSemiSetMsg.ITS_LDW = semiActiveITS_LDWGet();
			s_sysSemiSetMsg.ITS_FEB = semiActiveITS_FEBGet();
			s_sysSemiSetMsg.AT_MT = semiActiveAT_MTGet();
			s_sysSemiSetMsg.IdleStopFunction = semiActiveIdleStopFunctionGet();
			s_sysSemiSetMsg.E_PKB_And_AVH = semiActiveE_PKB_And_AVHGet();
			s_sysSemiSetMsg.IBA_OFF = semiActiveIBA_OFFGet();
			s_sysSemiSetMsg.IndirectIllumination = semiActiveIndirectIlluminationGet();
			s_sysSemiSetMsg.RearSeat = semiActiveRearSeatGet();
			s_sysSemiSetMsg.SLIP = semiActiveSLIPGet();
			s_sysSemiSetMsg.I_Key = semiActiveI_KEYGet();
			s_sysSemiSetMsg.OAT_With = semiActiveOAT_WithGet();
			s_sysSemiSetMsg.Sonar = semiSonarGet();
			s_sysSemiSetMsg.LED_HeadLamp = semiLED_HeadlampFlagGet();
			s_sysSemiSetMsg.EAPM = semiEAPMFlagGet();
			s_sysSemiSetMsg.ITS_TJP = semiActiveITS_TJPGet(); /* yangxl */
			s_sysSemiSetMsg.ITS_ICC = semiActiveITS_ICCGet(); /* yangxl */
			
			s_sysSemiSetMsg.LightSensitivity = semiLightSensitivityFlagGet(); 						/* yangxl */
			s_sysSemiSetMsg.LightOffDay = semiLightOffDayFlagGet(); 								/* yangxl */
			s_sysSemiSetMsg.AutoFoldFunction = semiAutoFoldFunctionFlagGet(); 						/* yangxl */
			s_sysSemiSetMsg.AutoLockFunctionCustomize = semiAutoLockFunctionCustomizeFlagGet(); 	/* yangxl */
			s_sysSemiSetMsg.LockAutoWindowUp = semiLockAutoWindowUpFlagGet(); 						/* yangxl */
			s_sysSemiSetMsg.AutoUnlockFunctionCustomize = semiAutoUnlockFunctionCustomizeFlagGet(); /* yangxl */
			s_sysSemiSetMsg.AnswerBack = semiAnswerBackFlagGet(); 									/* yangxl */
			s_sysSemiSetMsg.RainSensor = semiRainSensorFlagGet(); 									/* yangxl */
			s_sysSemiSetMsg.WiperWithWipingDrip = semiWiperWithWipingDripFlagGet(); 				/* yangxl */
			
			s_sysSemiSetMsg.ITS_ACC = semiActiveITS_ACCGet(); 										/* yangxl */
			s_sysSemiSetMsg.ITS_LKA = semiActiveITS_LKAGet(); 										/* yangxl */

			s_sysSemiSetMsg.EQ_PIN = getITMasterCtrlVerion();   									/* yangxl */

			s_sysSemiSetMsg.ShiftByWire = semiActiveShiftByWireGet();								/* yangxl */
			
			buf[0]= FUN_ID_SEMI_SET_MSG;
			buf[1]= 0x03;

			memset(&buf[2], 0, 8);
			memcpy(&buf[2], &s_sysSemiSetMsg, sizeof(s_sysSemiSetMsg));
			//call tx routine
			if(ipc_gw_is_ch_connected(IPC_CH_REQ))
			{
				SentReqEvent(buf, sizeof(s_sysSemiSetMsg)+2);
			}		
		}	

		if(SysSettingUpFlagGet())
		{
			SysSettingUpFlagSet(0);
			s_sysSetMsg = SysSettingGet();
			buf[0]= FUN_ID_SYS_SET_MSG;
			buf[1]= 0x03;

			memset(&buf[2], 0, 8);
			memcpy(&buf[2], &s_sysSetMsg, sizeof(s_sysSetMsg));
			//call tx routine
			if(ipc_gw_is_ch_connected(IPC_CH_REQ))
			{
				SentReqEvent(buf, sizeof(s_sysSetMsg)+2);
			}		
		}

		
		if((s_sysCtrl.IgnState != DEA_GetIgnStat()) || (s_sysCtrl.AccState != DEA_GetAccStat()) 
			|| (s_sysCtrl.VoltageMode != PM_GetCurrentMode()) || (s_sysCtrl.CrankingStatus != DEA_GetCrankingStatus())
			||(s_sysCtrl.VoltageState != DEA_GetVoltageState()))
		{
			l_power_changed_flag = 1;
		}
		else
		{
			l_power_changed_flag = 0;
		}
		if((((l_times+(l_time_pos++))% 10) == 0) || (l_power_changed_flag == 1)) //memcmp(&l_sysCtrl, &s_sysCtrl, sizeof(s_sysCtrl)) == 0)
		{
			buf[0]= FUN_ID_SYS_CTRL_MSG;
			buf[1]= 0x3F;

			s_sysCtrl.IgnState = DEA_GetIgnStat();
			s_sysCtrl.AccState = DEA_GetAccStat();
			s_sysCtrl.VoltageMode = PM_GetCurrentMode();
			//s_sysCtrl.PredriveCheck = 1U;
			s_sysCtrl.DarkMode = DEA_GetNightDimmerFlag();
			s_sysCtrl.CrankingStatus = DEA_GetCrankingStatus();
			s_sysCtrl.IdleStopPermition = DEA_GetRawRevolutionIdleStat();
			s_sysCtrl.VoltageState = DEA_GetVoltageState();
			memset(&buf[2], 0, 8);
			memcpy(&buf[2], &s_sysCtrl, sizeof(s_sysCtrl));

			//call tx routine
			if(ipc_gw_is_ch_connected(IPC_CH_REQ))
			{
				Ic_ipc_gw_send_notification(IPC_CH_REQ, (uint16_t)0, IPC_FEATURE_IOC_NTF, buf, sizeof(s_sysCtrl)+2);
			}
		}
		
		msg_size = GetMsgRingSize(&s_warnMsgRing);
		if(msg_size > 0)
		{
			if(msg_size > 4)
			{
				msg_size = 4;
			}
			buf[0]= FUN_ID_WARN_MSG;
			buf[1]= 0x00;
			for(i = 0; i < msg_size; i++)
			{
				buf[1] |= 0x01 << i;
			}
			
			memset(&buf[2], 0, 8);
			readFromRingToBuf(&s_warnMsgRing, &buf[2], msg_size);
			//call tx routine
			if(ipc_gw_is_ch_connected(IPC_CH_REQ))
			{
				s_start = xTaskGetTickCount();
				SentReqEvent(buf, 10);
			}
		}
	
		msg_size = GetMsgRingSize(&s_normalMsgRing);
		if(msg_size > 0)
		{
			if(msg_size > 4)
			{
				msg_size = 4;
			}
			buf[0]= FUN_ID_NORMAL_MSG;
			buf[1]= 0x00;
			for(i = 0; i< msg_size; i++)
			{
				buf[1] |= 0x01 << i;
			}
			
			memset(&buf[2], 0, 8);
			readFromRingToBuf(&s_normalMsgRing, &buf[2], msg_size);
			//call tx routine
			if(ipc_gw_is_ch_connected(IPC_CH_REQ))
			{
				s_start = xTaskGetTickCount();
				SentReqEvent(buf, 10);
			}
		}


		//if(DEA_GetIgnStat() == IGN_ON)
		{		
		#if 0	
			l_buttonMsg.BackButton = DEA_GetMODEBottonValue();
			l_buttonMsg.DispButton = DEA_GetDISPBottonValue();
			l_buttonMsg.DownButton = DEA_GetMENU_DOWNBottonValue();
			l_buttonMsg.OkButton = DEA_GetSW_OKBottonValue();
			l_buttonMsg.SourceButton = DEA_GetSRCBottonValue();
			l_buttonMsg.TelButton = DEA_GetTEL_ONBottonValue();
			l_buttonMsg.UpButton = DEA_GetMENU_UPBottonValue();
			l_buttonMsg.VoiceRecButton =DEA_GetCAMERABottonValue();
			l_buttonMsg.VolDownButton = DEA_GetVOL_DOWNBottonValue();
			l_buttonMsg.VolUpButton = DEA_GetVOL_UPBottonValue();
			l_buttonMsg.Reserved = 0U;
		#else	
			l_buttonMsg.KeyStrgUp = DEA_GetKeyStrgUpValue();
			l_buttonMsg.KeyStrgDown = DEA_GetKeyStrgDownValue();
			l_buttonMsg.KeyStrgLeft = DEA_GetKeyStrgLeftValue();
			l_buttonMsg.KeyStrgRight = DEA_GetKeyStrgRightValue();
			l_buttonMsg.KeyStrgOk = DEA_GetKeyStrgOkValue();
			l_buttonMsg.KeyStrgDisp = DEA_GetKeyStrgDispValue();
			l_buttonMsg.KeyStrgTelOn = DEA_GetKeyStrgTelOnValue();
			l_buttonMsg.KeyStrgDvr =DEA_GetKeyStrgDvrValue();
			l_buttonMsg.KeyStrgLka = DEA_GetKeyStrgLkaValue();
			//l_buttonMsg.VolUpButton = DEA_GetVOL_UPBottonValue();
			l_buttonMsg.Reserved = 0U;
		#endif
			if(memcmp(&l_buttonMsg, &s_buttonMsg, sizeof(s_buttonMsg)) != 0)
			{
				s_buttonMsg = l_buttonMsg;
				buf[0]= FUN_ID_BUTTON_MSG;
				buf[1]= 0x0F;

				memset(&buf[2], 0, 8);
				memcpy(&buf[2], &s_buttonMsg, sizeof(s_buttonMsg));
				//KeyStrgTest();//yangxl Test
				//call tx routine
				if(ipc_gw_is_ch_connected(IPC_CH_REQ))
				{
					Ic_ipc_gw_send_notification(IPC_CH_REQ, (uint16_t)0, IPC_FEATURE_IOC_NTF, buf, sizeof(s_buttonMsg)+2);
				}
			}
		}

		if(s_timeUpdateFlag) //time set req
		{
			s_timeUpdateFlag = 0;
			buf[0]= FUN_ID_TIME_INFO_MSG;
			buf[1]= 0x03;

			memset(&buf[2], 0, 8);
			memcpy(&buf[2], &s_sysTimeInfoMsg.Format, sizeof(s_sysTimeInfoMsg));
			//call tx routine
			if(ipc_gw_is_ch_connected(IPC_CH_REQ))
			{
				SentReqEvent(buf, sizeof(s_sysTimeInfoMsg)+2);
			}

		}
		
		if(DEA_GetIgnStat() == IGN_ON)
		{
			s_IgnStatusBak = IGN_ON;
			if(((l_times+(l_time_pos++)) % 10) == 0)
			{
				buf[0]= FUN_ID_BASIC_FAST;
				buf[1]= 0x07;
				
				if(VEL_vGetVelMode() != VEL_Normal)
				{
					s_basicFast.VehicleSpeedStatus = 1U;
				}
				else
				{
					s_basicFast.VehicleSpeedStatus = 0;
				}
				if(DEA_GetVehicleSpeedDiagMode() == 0)
				{
					if(DEA_GetFilterVehicleSpeed() > 2400)
					{
						s_basicFast.VehicleSpeedValue = 2400;
					}
					else
					{
						s_basicFast.VehicleSpeedValue = DEA_GetFilterVehicleSpeed();
					}
				}
				else
				{
					s_basicFast.VehicleSpeedValue = DEA_GetFilterVehicleSpeedDiag();
				}
				s_basicFast.EngineSpeedStatus = !DEA_GetFilterEngineRevolutionValid();
				s_basicFast.EngineSpeedValue = DEA_GetFilterEngineRevolution();


				s_basicFast.InsFuelConsDisplayStat = !DEA_GetIFC_Valid();
				s_basicFast.InsFuelConsDisplayUnit = DEA_GetIFC_Unit();
				s_basicFast.InsFuelConsumption = DEA_GetIFC_Value();
				

				if(FUEL_GetFuelSigStatus() != FuelSigNormal)
				{
					s_basicFast.FuelStatus = 1;
				}
				else
				{
					s_basicFast.FuelStatus = 0;
				}
				s_basicFast.Fuel = FUEL_GetIndicatePos();

				if(DEA_GetCoolantTempValid())
				{
					s_basicFast.CoolantTempStatus = 0;
				}
				else
				{
					s_basicFast.CoolantTempStatus = 1;
				}
				s_basicFast.CoolantTemp = (DEA_GetCoolantIndAngle()/9); //The original scope is 0-900 ,trans range to 0-100
				
				memset(&buf[2], 0, 8);
				memcpy(&buf[2], &s_basicFast, sizeof(s_basicFast));
				//call tx routine
				if(ipc_gw_is_ch_connected(IPC_CH_NTF))
				{
					Ic_ipc_gw_send_notification(IPC_CH_NTF, (uint16_t)0, IPC_FEATURE_IOC_NTF, buf, sizeof(s_basicFast)+2);
				}
			}


			if(((l_times+(l_time_pos++))% 10) == 0)
			{
				buf[0]= FUN_ID_BASIC_MIDDLE;
				buf[1]= 0x1F;

				if(s_middle_switch_flag == 0)
				{
					s_middle_switch_flag = 1;
					//s_basicMiddle.AverageFuelConsIndex = 0;
					//s_basicMiddle.AverageFuelConsStat = !DEA_GetAFC_A_Valid();
					//s_basicMiddle.AverageFuelCons = DEA_GetAFC_A_Value();
					
					s_basicMiddle.AverageVehicleSpeedIndex = 0;
					s_basicMiddle.AverageVehicleSpeedStat = !DEA_GetAVSA_valid();
					s_basicMiddle.AverageVehicleSpeed = DEA_GetAVSA();

					s_basicMiddle.DriveTimeIndex = 0;
					s_basicMiddle.DriveTimeStat = !DEA_GetTripTimeAValid();
					s_basicMiddle.DriveTime = DEA_GetTripTimeA();

					s_basicMiddle.AveragePowerIndex = 0;
					s_basicMiddle.AveragePowerStat = !DEA_GetAvpPackAValueValid();
					s_basicMiddle.AveragePower = DEA_GetAvpPackAValue();
				}
				else
				{
					s_middle_switch_flag = 0;
					//s_basicMiddle.AverageFuelConsIndex = 1;
					//s_basicMiddle.AverageFuelConsStat = !DEA_GetAFC_B_Valid();
					//s_basicMiddle.AverageFuelCons = DEA_GetAFC_B_Value();
					
					s_basicMiddle.AverageVehicleSpeedIndex = 1;
					s_basicMiddle.AverageVehicleSpeedStat = !DEA_GetAVSB_valid();
					s_basicMiddle.AverageVehicleSpeed = DEA_GetAVSB();

					s_basicMiddle.DriveTimeIndex = 1;
					s_basicMiddle.DriveTimeStat = !DEA_GetTripTimeBValid();
					s_basicMiddle.DriveTime = DEA_GetTripTimeB();

					s_basicMiddle.AveragePowerIndex = 1;
					s_basicMiddle.AveragePowerStat = !DEA_GetAvpPackBValueValid();
					s_basicMiddle.AveragePower = DEA_GetAvpPackBValue();
				}

				if(s_middle_switch_flagavgf == 0)
				{
					s_middle_switch_flagavgf = 1;
					s_basicMiddle.AverageFuelConsIndex = 0;
					s_basicMiddle.AverageFuelConsStat = !DEA_GetAFC_A_Valid();
					s_basicMiddle.AverageFuelCons = DEA_GetAFC_A_Value();
				}else if(s_middle_switch_flagavgf == 1)
				{
					s_middle_switch_flagavgf = 2;
					s_basicMiddle.AverageFuelConsIndex = 1;
					s_basicMiddle.AverageFuelConsStat = !DEA_GetAFC_B_Valid();
					s_basicMiddle.AverageFuelCons = DEA_GetAFC_B_Value();
				}else
				{
					s_middle_switch_flagavgf = 0;
					s_basicMiddle.AverageFuelConsIndex = 2;
					s_basicMiddle.AverageFuelConsStat = !GetAfcValid();
					s_basicMiddle.AverageFuelCons = GetAfcShow();
				}

				
				s_basicMiddle.DTE_Status = Get_DteState();
				s_basicMiddle.DTE = DEA_GetDTE();
	
				
				if(1)//DEA_GetCodingOATOnOff() == DEA_CODING_ON)
				{
					s_basicMiddle.OutsideAirTempStat = !DEA_GetOAT_Valid();
					s_basicMiddle.OutsideAirTemp =  (DEA_GetOAT_FilterValue()+40);	//0ffset = -40
				}
				else
				{
					s_basicMiddle.OutsideAirTempStat = 0;
					s_basicMiddle.OutsideAirTemp =  0;	//0ffset = -40
				}
				//s_basicMiddle.Mode = 0x01;
				if(DEA_GetFilterGearValueValid())
				{
					if(Get_GearMode() != METER_OFF)
					{
						s_basicMiddle.Gear = DEA_GetFilterGearValue();//DEA_GetFilterGearValue();
					}
					else
					{
						s_basicMiddle.Gear = 0;
					}
					if(Get_GearAtShow2() == Show_M)
					{
						if(Get_GearMode() == METER_BLINK)
						{
							s_basicMiddle.Mode = 3;
						}
						else
						{
							s_basicMiddle.Mode = 1;
						}
					}
					else
					{
						if(Get_GearMode() == METER_BLINK)
						{
							s_basicMiddle.Mode = 2;
						}
						else
						{
							s_basicMiddle.Mode = 0;
						}
					}
					s_basicMiddle.Up_Down = Get_GearAtShow3();
				}
				else
				{
					s_basicMiddle.Mode = 0;
					s_basicMiddle.Gear = 0;
					s_basicMiddle.Up_Down = 0;
				}
				s_basicMiddle.AccGuideStatus = !DEA_GetFilterAccelGuideValValid();
				s_basicMiddle.AccGuide = DEA_GetFilterAccelGuideValue();
				s_basicMiddle.EcoRank =  DEA_GetFilterAccelGuide_Y();
				if(FUEL_GetFuelVolumeValid() == 1)
				{
					s_basicMiddle.RemainFuelStatus = 0;
					s_basicMiddle.RemainFuelVol = (uint16_t)(FUEL_GetFuelVol()/10);
				}
				else
				{
					s_basicMiddle.RemainFuelStatus = 1;
					s_basicMiddle.RemainFuelVol = 0;
				}
				//s_basicMiddle.Up_Down = 1;
				memset(&buf[2], 0, 9);
				memcpy(&buf[2], &s_basicMiddle, sizeof(s_basicMiddle));
				//call tx routine
				if(ipc_gw_is_ch_connected(IPC_CH_NTF))
				{
					Ic_ipc_gw_send_notification(IPC_CH_NTF, (unsigned char)0, IPC_FEATURE_IOC_NTF, buf, sizeof(s_basicMiddle)+2);
				}
			}

			SelfDiagDynamicStatusProc(&s_SelfDiagDynamic);
			if(s_sysCtrl.PredriveCheck == 1)
			{
				s_PredriveCheckStatus = 1;
			}else
			{
				if(s_PredriveCheckStatus != 0)
				{
					s_PredriveCheckStatus = 0;
					ClearSelfDiagErrorCodeProc(&s_SelfDiagDynamic);
				}
			}
			
			if((s_sysCtrl.PredriveCheck == 1) && (((l_times+(l_time_pos++)) % 10) == 0))
			{
				buf[0]= FUN_ID_SELF_DIAG_D;
				buf[1]= 0x07;

				//SelfDiagDynamicStatusProc(&s_SelfDiagDynamic);

				memcpy(&buf[2], &s_SelfDiagDynamic, sizeof(s_SelfDiagDynamic));
				//call tx routine
				if(ipc_gw_is_ch_connected(IPC_CH_NTF))
				{
					Ic_ipc_gw_send_notification(IPC_CH_NTF, 0, IPC_FEATURE_IOC_NTF, buf, sizeof(s_SelfDiagDynamic)+2);
				}
			}

			if((DEA_GetFilterTravelTime_H() != s_TravelTime_Hour)
				||(DEA_GetFilterTravelTime_M() != s_TravelTime_Minute)
				||(DEA_GetFilterTravelTime_S() != s_TravelTime_Second))
			{
				s_TravelTime_Hour = DEA_GetFilterTravelTime_H();
				s_TravelTime_Minute = DEA_GetFilterTravelTime_M();
				s_TravelTime_Second = DEA_GetFilterTravelTime_S();
				
				buf[0]= FUN_ID_DRIVE_TIME;
				buf[1]= 0x07;
				if(s_TravelTime_Hour > 0)
				{
					s_DriveTime.DriveTime[0] = s_TravelTime_Hour;
					s_DriveTime.DriveTime[1] = s_TravelTime_Minute;
				}
				else
				{
					s_DriveTime.DriveTime[0] = s_TravelTime_Minute;
					s_DriveTime.DriveTime[1] = s_TravelTime_Second;
				}
				memcpy(&buf[2], &s_DriveTime, sizeof(s_DriveTime));
				//call tx routine
				if(ipc_gw_is_ch_connected(IPC_CH_REQ))
				{
					Ic_ipc_gw_send_notification(IPC_CH_REQ, 0, IPC_FEATURE_IOC_NTF, buf, sizeof(s_DriveTime)+2);
				}
			}

			if(Is_IdleStopInfoChanged(&s_IdleStopInfo) || (l_power_changed_flag != 0))
			{

				s_IdleStopInfo.IdleStopFuelA = DEA_GetFilterfuelCumulativeValue();
				s_IdleStopInfo.IdleStopFuelB = DEA_GetFilterfuelLtripValue();
				s_IdleStopInfo.IdleStopTimeA[0] = DEA_GetFilterCumulativeValue_H();
				s_IdleStopInfo.IdleStopTimeA[1] = DEA_GetFilterCumulativeValue_M();
				s_IdleStopInfo.IdleStopTimeA[2] = DEA_GetFilterCumulativeValue_S();
				
				s_IdleStopInfo.IdleStopTimeB[0] = DEA_GetFilterlTripValue_H();
				s_IdleStopInfo.IdleStopTimeB[1] = DEA_GetFilterlTripValue_M();
				s_IdleStopInfo.IdleStopTimeB[2] = DEA_GetFilterlTripValue_S();

				buf[0]= FUN_ID_IDLE_STOP;
				buf[1]= 0x07;
				memcpy(&buf[2], &s_IdleStopInfo, sizeof(s_IdleStopInfo));
				//call tx routine
				if(ipc_gw_is_ch_connected(IPC_CH_REQ))
				{
					Ic_ipc_gw_send_notification(IPC_CH_REQ, 0, IPC_FEATURE_IOC_NTF, buf, sizeof(s_IdleStopInfo)+2);
				}
			}
		}
		else
		{
			if(s_IgnStatusBak != IGN_OFF)
			{
				s_IgnStatusBak = IGN_OFF;

				buf[0]= FUN_ID_BASIC_FAST;
				buf[1]= 0x07;
				memset(&buf[2], 0, 8);
				//call tx routine
				if(ipc_gw_is_ch_connected(IPC_CH_NTF))
				{
					Ic_ipc_gw_send_notification(IPC_CH_NTF, (uint16_t)0, IPC_FEATURE_IOC_NTF, buf, sizeof(s_basicFast)+2);
				}

				buf[0]= FUN_ID_BASIC_MIDDLE;
				buf[1]= 0x1F;

				s_basicMiddle.DTE_Status = Get_DteState();
				s_basicMiddle.DTE = DEA_GetDTE();

				s_basicMiddle.OutsideAirTempStat = 1;		//invalid
				memset(&buf[2], 0, 9);
				memcpy(&buf[2], &s_basicMiddle, sizeof(s_basicMiddle));
				//call tx routine
				if(ipc_gw_is_ch_connected(IPC_CH_NTF))
				{
					Ic_ipc_gw_send_notification(IPC_CH_NTF, (unsigned char)0, IPC_FEATURE_IOC_NTF, buf, sizeof(s_basicMiddle)+2);
				}

				//ClearSelfDiagErrorCodeProc(&s_SelfDiagDynamic);//yangxl 2020-5-8 14:25:49
				if(s_PredriveCheckStatus != 0)
				{
					s_PredriveCheckStatus = 0;
					ClearSelfDiagErrorCodeProc(&s_SelfDiagDynamic);
				}
			}
		}

		if(((DEA_GetIgnStat() == IGN_ON) && ((l_times % 50) == 0)) || (s_power_on_update_flag != 0))
		{
			buf[0]= FUN_ID_BASIC_SLOW;
			buf[1]= 0x07;
			s_basicSlow.OdometerStatus = 0x00;
			s_basicSlow.Odometer = DEA_GetOdo();
			s_basicSlow.TripAStatus = !DEA_GetTripA_Status();
			s_basicSlow.TripA = DEA_GetTripA();
			s_basicSlow.TripBStatus = !DEA_GetTripB_Status();
			s_basicSlow.TripB = DEA_GetTripB();	
			if(DEA_GetMaintainDistance() > 0)
			{
				s_basicSlow.Service = (uint16_t)SERV_GetDistance();
			}
			else
			{
				s_basicSlow.Service = 0;
			}
			memset(&buf[2], 0, 8);
			//COVER_BASIC_SLOW_TO_BUF((s_basicSlow),(&buf[2]));
			memcpy(&buf[2], &s_basicSlow, sizeof(s_basicSlow));
			//call tx routine
			if(ipc_gw_is_ch_connected(IPC_CH_NTF))
			{
				Ic_ipc_gw_send_notification(IPC_CH_NTF, (unsigned char)0, IPC_FEATURE_IOC_NTF, buf, sizeof(s_basicSlow)+2);
			}
		}
#if 0   
		if(DEA_GetIgnStat() == IGN_OFF)
		{
			s_IgnBackForHisAfc = IGN_OFF;
			if(Is_HistoryAvgFuelChanged(&s_HistoryAvgFuel) || (s_UpdateBestHisFuelFlag == 1))
			{
				if(s_UpdateBestHisFuelFlag == 1)
				{
					s_UpdateBestHisFuelFlag = 0;
					s_HistoryAvgFuel.BestAvgFuelEconomy = DEA_GetFilterBestHistoryAfcValue();
					l_HistoryAvgFuel = s_HistoryAvgFuel;
					l_HistoryAvgFuel.HistoryAvgFuelEconomyFlag = 0;
					l_HistoryAvgFuel.EcoRank = 0;
				}
				else
				{
					l_HistoryAvgFuel = s_HistoryAvgFuel;
				}
				buf[0]= FUN_ID_HIS_AVG_FUEL;
				buf[1]= 0x03;

				memset(&buf[2], 0, 16);
				memcpy(&buf[2], &l_HistoryAvgFuel, sizeof(IPC_APP_HISTORY_AVG_FUEL_STRU));
				//call tx routine
				if(ipc_gw_is_ch_connected(IPC_CH_REQ))
				{
					SentReqEvent(buf, sizeof(IPC_APP_HISTORY_AVG_FUEL_STRU)+2);
				}	
			}
		}
		else
		{
			if(s_IgnBackForHisAfc == IGN_OFF)
			{
				s_IgnBackForHisAfc = IGN_ON;
				s_HistoryAvgFuel.HistoryAvgFuelEconomyFlag = 0;
				s_HistoryAvgFuel.EcoRankFlag = 0;
				buf[0]= FUN_ID_HIS_AVG_FUEL;
				buf[1]= 0x03;

				memset(&buf[2], 0, 16);
				memcpy(&buf[2], &s_HistoryAvgFuel, sizeof(s_HistoryAvgFuel));
				//call tx routine
				if(ipc_gw_is_ch_connected(IPC_CH_REQ))
				{
					SentReqEvent(buf, sizeof(s_HistoryAvgFuel)+2);
				}	
			}
		}

		if(s_ResetHisFuelFlag == 1)
		{
			s_ResetHisFuelFlag = 0;

			s_HistoryAvgFuel.HistoryAvgFuelEconomyFlag = 0;
			s_HistoryAvgFuel.EcoRankFlag = 0;
			*((HIS_AFC *)(&s_HistoryAvgFuel.LastAF1)) = DEA_GetFilterHistoryAfcValue();
			s_HistoryAvgFuel.BestAvgFuelEconomy = DEA_GetFilterBestHistoryAfcValue();
			buf[0]= FUN_ID_HIS_AVG_FUEL;
			buf[1]= 0x03;

			memset(&buf[2], 0, 16);
			memcpy(&buf[2], &s_HistoryAvgFuel, sizeof(s_HistoryAvgFuel));
			//call tx routine
			if(ipc_gw_is_ch_connected(IPC_CH_REQ))
			{
				SentReqEvent(buf, sizeof(s_HistoryAvgFuel)+2);
			}	
		}
#else 
		if(GetHisAfcUpdateFlg()==1u)
		{
			SetHisAfcUpdateFlg(0u);
			
			buf[0]= FUN_ID_HIS_AVG_FUEL;
			buf[1]= 0x03;

			memset(&buf[2], 0, 16);
			l_HisAvgFuelData = GetHisAfcData();
			memcpy(&buf[2], &l_HisAvgFuelData, sizeof(l_HisAvgFuelData));
			//memcpy(&buf[2], &s_HistoryAvgFuel, sizeof(s_HistoryAvgFuel));
			//call tx routine
			//HisAfcDataTest();//201961010:42:57
			//HisAfcDataTest1(l_HisAvgFuelData);//201961010:42:57
			if(ipc_gw_is_ch_connected(IPC_CH_REQ))
			{
				//SentReqEvent(buf, sizeof(s_HistoryAvgFuel)+2);
				//SentReqEvent(buf, sizeof(l_HisAvgFuelData)+2);
				Ic_ipc_gw_send_notification(IPC_CH_REQ, (unsigned char)0, IPC_FEATURE_IOC_NTF, buf, sizeof(l_HisAvgFuelData)+2);
			}	
		}
#endif  
		if((Is_CanTimeoutChanged(l_CanMessageTimeoutBuf, s_CanMessageTimeoutStat, IPC_CAN_TIMEOUT_BUF_SIZE))||(l_times%50 == 0))// update data 2019-10-24 09:56:22
		{
			memcpy(l_CanMessageTimeoutBuf, s_CanMessageTimeoutStat, IPC_CAN_TIMEOUT_BUF_SIZE);
			if(ipc_gw_is_ch_connected(IPC_CH_REQ))
			{
				buf[0] = FUN_ID_CAN_TIMEOUT;
				buf[1] = 0x01;
				memcpy(&buf[2], l_CanMessageTimeoutBuf, IPC_CAN_TIMEOUT_BUF_SIZE);
				SentReqEventChCan(buf, IPC_CAN_TIMEOUT_BUF_SIZE+2, 0);
			}
		}

		if(IPC_HardwareProc(&buf[2], 4))
		{
			if(ipc_gw_is_ch_connected(IPC_CH_CAN))
			{
				buf[0] = FUN_ID_HARDWARE_SIG;
				buf[1] = 0x01;
				SentReqEventChCan(buf, 6, 0);
			}
		}
		/*
		if(s_IocStatUpdate_flag)
		{
			s_IocStatUpdate_flag = 0;
			buf[0] = FUN_ID_IOC_STAT;
			buf[1] = 0x01;

			s_IocStat.ResetType = (DEA_GetSysRstType() == RST_IRRST)?1:0;
			memcpy(&buf[2], &s_IocStat, sizeof(s_IocStat));
			if(ipc_gw_is_ch_connected(IPC_CH_CAN))
			{
				SentReqEventChCan(buf, sizeof(s_IocStat)+2, 0);
			}
		}
		*/
		if((s_IocStatUpdate_flag)||(s_IocDteStatUpdate_flag))
		{
			if(s_IocDteStatUpdate_flag)
			{
				s_IocStat.dte30sflg = 1u;
				
			}else
			{
				s_IocStat.dte30sflg = 0u;
			}
			s_IocStatUpdate_flag = 0;
			s_IocDteStatUpdate_flag = 0;
			
			buf[0] = FUN_ID_IOC_STAT;
			buf[1] = 0x01;

			s_IocStat.ResetType = (DEA_GetSysRstType() == RST_IRRST)?1:0;
			memcpy(&buf[2], &s_IocStat, sizeof(s_IocStat));
			if(ipc_gw_is_ch_connected(IPC_CH_CAN))
			{
				SentReqEventChCan(buf, sizeof(s_IocStat)+2, 0);
			}
		}

#if (STD_ON == TASK_IPCAPP_STACK_MONITOR)
		if(min_stack > uxTaskGetStackHighWaterMark(NULL))
		{
			min_stack = uxTaskGetStackHighWaterMark(NULL);
#if (STD_ON == TASK_IPCAPP_DEBUG_TRACE)
			TracePrintf(IPC_TRACE,0,0,0, "[T-IPC]IPC_App: %d\r\n", min_stack);
#endif
		}
#endif	
		s_power_on_update_flag = 0;
		vTaskDelayUntil(&xLastWakeTime, 10U);
		
	}
}

/*=========================== END OF FILE: Task_IpcApp.c ===========================*/
