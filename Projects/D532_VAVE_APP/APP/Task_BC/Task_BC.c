/*!Warning!:Please don't modify this file,this is generated by tools!*/
/********************************************************************
File name: Task_BC.c
Author: Stephen Du
Version: V1.0
Timestamp: 2017-05-26 11:36:42
Description:
Others:
Function List:
1. ....
History: /
1. Date:
Author:
Modification:
2. ...
********************************************************************/
//#include "System_Task_If.h"
//#include "System_Signal_If.h"
#include "Task_BC_Cfg.h"
#if (STD_ON == TASK_BC_DEBUG_TRACE)
#include "trace.h"
#endif
#include "odo.h"
#include "FuelProc.h"
#include "Vel.h"
#include "Rev.h"
//#include "Tt.h"
#include "oat.h"
#include "tii.h"
#include "afc.h"
#include "cti.h"
#include "ifc.h"
#include "dte.h"
#include "avs.h"
#include "VEL_LT.h"
#include "unit.h"
#include "MaintainService.h"

#include "Elm.h"
#include "Prm.h"
#include "IpcClr.h"
#include "DriveComputer.h"
#include "MotorSp.h"
#include "Gear.h"

#include "TravelTime.h"
#include "AccelGuide.h"
#include "eco.h"
#include "IdleStopTime.h"
#include "HistoryAfc.h"
#include "FreeRTOS.h"
#include "task.h"
#include "semi_active_check.h"
#include "BinSig_Acc_Cfg.h"
#include "dea.h"



extern void Diagtest(void); /*yangxl*/

 

void BC_Init(void)
{
	Soc_Init();
	Prm_Init();
	Oat_Init();
	MotorSp_Init();
	DriverCpt_Init();
	Gear_Init();

	TravelTime_Init();
	AccelGuide_Init();
	ECO_Init();
	IDLE_FUEL_Init();
	//HAFC_Init();
	HisAfcInit();//yangxl
	
	ODO_Init();
	TII_vInit();
	VEL_vInit();
	REV_vInit();
	CTI_vInit();
	IFC_vInit();
	DTE_Init();
	AVS_vInit();
	AFC_vInit();
	VEL_LT_vInit();
	vMaintianServInit();
	UNIT_Init();
	//DIMM_Cfg_Init();
	SysSettingInit();
}

//#define TEMP_FOR_IGN
void Task_BC(void * pvParameters)
{
	boolean l_returnValue = E_NOT_OK;
	uint32_t xLastWakeTime = 0U;
	//SystemTaskMsgInfoType l_msgInfo = {0XFFFF, 0U, NULL};
	uint16_t l_times = 0;

#ifdef TEMP_FOR_IGN
	static uint8_t s_portState = 0;//BINSIG_ACC_GET_PORT_VALUE;
	static uint16_t s_portStateCnt = 0;
#endif
	
	/*Warning: You need change the following array's size according to your real length.*/
	//uint8 l_msgDataBuf[4] = {0U, 0U, 0U, 0U};
#if (STD_ON == TASK_BC_STACK_MONITOR)
	uint16 l_stackSize = 0U;
#endif

	//l_msgInfo.parBufPtr = &l_msgDataBuf[0];
	
	/*===============================================================================*/
	/*=============================== START: USER CODE ==============================*/
	/*===============================================================================*/
	/*
	System_Signal_Subscribe(SYSTEM_SIG_ID_XXX, SYSTEM_TASK_ID_BC);
	System_Signal_SubSpecValue(SYSTEM_SIG_ID_XXX, SYSTEM_TASK_ID_BC, X);
	*/

	/*===============================================================================*/
	/*================================ END: USER CODE ===============================*/
	/*===============================================================================*/
	BC_Init();

	//DEA_SetAccStat(ACC_ON);
	//DEA_SetIgnStat(IGN_ON);
	xLastWakeTime = xTaskGetTickCount();
	DEA_SetResetMagicWord(RESET_MAGIC_VALUE);
	BACKRAM_MAGIC2 = RESET_MAGIC_VALUE;
	while (1)
	{
		//l_returnValue = System_Task_ReceiveMessage(SYSTEM_TASK_ID_BC, &l_msgInfo, FALSE, 0);
		if (E_OK == l_returnValue)
		{
			/*
			You can use: "l_msgInfo.msgId" to get the message id.
			You can use: "l_msgInfo.size" to get the message size.
			You can use: "l_msgInfo.parBufPtr[]" or "l_msgDataBuf[]"
			             to get the message content if the message size not equal 0.
			 */
			/*===============================================================================*/
			/*=============================== START: USER CODE ==============================*/
			/*===============================================================================*/
			/*if (SYSTEM_SIG_ID_XXX == l_msgInfo.msgId)
			{
#if (STD_ON == TASK_BC_DEBUG_TRACE)
				TracePrintf(BC_TRACE, TRACE_INFO, "[Task_BC-I]:Some infomation\r\n");
#endif
			}*/

			/*===============================================================================*/
			/*================================ END: USER CODE ===============================*/
			/*===============================================================================*/
#if (STD_ON == TASK_BC_STACK_MONITOR)
			l_stackSize = uxTaskGetStackHighWaterMark(NULL);
#if (STD_ON == TASK_BC_DEBUG_TRACE)
			TracePrintf(BC_TRACE, TRACE_WARNING,  FILE_ID, LINE_NUM, "[Task_BC-W]:Stack Size:%d\r\n",l_stackSize);
#endif
#endif
		}
		l_times++;
		if(l_times >= 50000)
		{
			l_times = 0;
		}
#ifdef TEMP_FOR_IGN
		if(s_portState != BINSIG_ACC_GET_PORT_VALUE)
		{
			if(s_portStateCnt < 10)
			{
				s_portStateCnt++;
			}
			else
			{
				s_portState = BINSIG_ACC_GET_PORT_VALUE;

				if(s_portState)
				{
					DEA_SetIgnStat((IGN_STAT_ENUM)s_portState);
					DEA_SetAccStat((ACC_STAT_ENUM)s_portState);
				}
				else
				{	
					DEA_SetIgnStat((IGN_STAT_ENUM)s_portState);
					DEA_SetAccStat((ACC_STAT_ENUM)s_portState);
				}
			}
		}
		else
		{
			s_portStateCnt = 0;
		}
#endif
		
		FUEL_FuelProc();//fuel vol(10ms cycle)

		

		
		if((l_times%100) == 0) //1s
		{
			//Elm_SocMain();//SOC meter(skon_106 project requirement)
			
			//ReMilge_MAIN();//elect remain millage(skon_106 project requirement)

			TravelTime_VMAIN();//591 project travel time
			ECO_VMAIN();//591 project ECO rate
		}
		
		if((l_times%5) == 0)//50ms
		{
			//Vpack_MAIN();//voltage meter(skon_106 project requirement)

			//Ipack_MAIN();//current meter(skon_106 project requirement)

			//PRM_Main();//Power meter(skon_106 project requirement)
			
			//Vehicle Fileter handle, later will focus the IGN, now ignore it for test
			VEL_vMain();//vechile speed
			

			//REV module, adjust the time later
			REV_vMain();//engine speed
			
			//VEL_LT_vMain();
		}
		
		//vTaskSuspendAll();//suspend all tasks
		ODO_MillageProc();//millage
		if((l_times%10) == 0)//100ms
		{
			ODO_Main();//ODO
			TII_vMain();//Instantaneous injection fuel
			IFC_vMain();//Instantaneous fuel consume
			AFC_vMain();//AFC_tripA,AFC_tripB
			CTI_vMain();//coolant tempreture
			DTE_Main();//remain distence
			//OAT_Main();//outside environment tempreture
			AVS_vMain();//AVS_tripA,AVS_tripB
			vMaintianServMain();//maintain distence

			//MotorSp_MAIN();//motor speed(skon_106 project requirement)
			
			CurrentTrip_MAIN();//IGN_OFF more than 2 hours? reset AVS_tripB,AFC_tripB,AVS_triptimeB,tripB (skon_106 project requirement)

			AccelGuide_VMAIN();//591 project AccelGuide

			IDLE_FUEL_vMAIN();//591 project idle passing time & idle fuel

			//HisAfc_VMAIN();//591 project History AFC
			HisAfcMain();//yangxl 532 project History AFC
		}
		#if 0
		Diagtest();/*yangxl*/
		#endif
		//xTaskResumeAll();//resume all tasks
		//Power_Batt_Scan();//power scan
		//TestDimmSenser();
		//TT module and AVS module
		//TT_vMain();//
		UNIT_vMain();//date mode£¬languange setting
		//System_Task_Delay(10);
		vTaskDelayUntil(&xLastWakeTime, 10U);//task delay time 10ms
	}
}
/*=========================== END OF FILE: Task_BC.c ===========================*/
